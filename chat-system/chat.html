<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¼‚è±¡ä¸­å­¦å­¦ç”Ÿå®åé€šè®¯ç³»ç»Ÿ / School Chat System</title>
  <link rel="stylesheet" href="chat-style.css">
</head>
<body>

<div class="chat-app">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="user-card">
        <div class="avatar-circle" id="myAvatar">U</div>
        <div class="user-info">
          <h3 id="currentUser">Loading...</h3>
          <span class="lang-cn-only">åœ¨çº¿</span>
          <span class="lang-en-only">Online</span>
        </div>
      </div>

      <select class="lang-selector" style="margin-bottom: 0.5rem; width: 100%; font-size: 0.85rem;">
        <option value="cn">Language: ä¸­æ–‡</option>
        <option value="en">Language: English</option>
      </select>

      <button onclick="logout()" class="btn btn-secondary" style="width:100%; font-size:0.8rem;">
        <span class="lang-cn-only">é€€å‡ºç™»å½•</span>
        <span class="lang-en-only">Logout</span>
      </button>
    </div>

    <div class="conversation-list" id="conversationList">
    </div>
  </aside>

  <main class="chat-window" id="chatWindow">
    <header class="chat-header">
      <div class="chat-title" id="chatTitle">SchoolChat</div>

      <button class="btn btn-ghost mobile-only" onclick="closeChat()" style="display:none;">
        <span class="lang-cn-only">è¿”å›åˆ—è¡¨</span>
        <span class="lang-en-only">Back</span>
      </button>
    </header>

    <div class="message-area" id="messageList">
      <div style="height:100%; display:flex; align-items:center; justify-content:center; flex-direction:column; color:var(--text-muted);">
        <div style="font-size:3rem; margin-bottom:1rem;">ğŸ’¬</div>
        <p>
          <span class="lang-cn-only">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå¯¹è¯å¼€å§‹èŠå¤©</span>
          <span class="lang-en-only">Select a conversation to start chatting</span>
        </p>
      </div>
    </div>

    <div class="input-area">
      <button class="btn btn-ghost" style="padding:0.5rem; border-radius:50%;">â•</button>

      <div class="fake-input i18n-attr"
           data-attr="data-text"
           data-cn="è¾“å…¥æ¶ˆæ¯... (åªè¯»æ¨¡å¼)"
           data-en="Type a message... (Read Only)">
        <span class="lang-cn-only">è¾“å…¥æ¶ˆæ¯... (åªè¯»æ¨¡å¼)</span>
        <span class="lang-en-only">Type a message... (Read Only)</span>
      </div>

      <button class="btn btn-primary" style="border-radius:50%; width:40px; height:40px; padding:0;">â¤</button>
    </div>
  </main>
</div>

<div id="passwordModal" class="modal-overlay">
  <div class="modal-card">
    <div style="text-align:center; margin-bottom:1.5rem;">
      <div style="width:50px; height:50px; background:#fee2e2; color:#ef4444; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1rem auto; font-size:1.5rem;">ğŸ”’</div>

      <h3 id="modalTitle" style="font-size:1.2rem; font-weight:700;">
        <span class="lang-cn-only">åŠ å¯†å¯¹è¯</span>
        <span class="lang-en-only">Encrypted Chat</span>
      </h3>

      <p style="color:var(--text-muted); font-size:0.9rem; margin-top:0.5rem;">
        <span class="lang-cn-only">æ­¤å¯¹è¯å†…å®¹å—å¯†ç ä¿æŠ¤ï¼Œè¯·è¾“å…¥å¯†ç è§£é”ã€‚</span>
        <span class="lang-en-only">This chat is password protected. Enter password to unlock.</span>
      </p>
    </div>

    <input type="password" id="passwordInput" class="input-field i18n-attr"
           data-attr="placeholder"
           data-cn="è¾“å…¥è®¿é—®å¯†ç "
           data-en="Enter Password"
           placeholder="è¾“å…¥è®¿é—®å¯†ç ">

    <div id="passwordError" style="color:#ef4444; font-size:0.85rem; margin-bottom:1rem; display:none; text-align:center;">
      <span class="lang-cn-only">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</span>
      <span class="lang-en-only">Incorrect password, please try again</span>
    </div>

    <div id="passwordHint" style="background:#f3f4f6; padding:0.8rem; border-radius:0.5rem; font-size:0.85rem; color:var(--text-muted); margin-bottom:1rem; display:none;">
    </div>

    <div style="display:flex; gap:0.5rem;">
      <button id="showHintBtn" class="btn btn-ghost" style="flex:1; font-size:0.85rem;">
        <span class="lang-cn-only">æ˜¾ç¤ºæç¤º</span>
        <span class="lang-en-only">Show Hint</span>
      </button>
      <button id="cancelPasswordBtn" class="btn btn-secondary" style="flex:1;">
        <span class="lang-cn-only">å–æ¶ˆ</span>
        <span class="lang-en-only">Cancel</span>
      </button>
      <button id="confirmPasswordBtn" class="btn btn-primary" style="flex:1;">
        <span class="lang-cn-only">è§£é”</span>
        <span class="lang-en-only">Unlock</span>
      </button>
    </div>
  </div>
</div>

<script src="../tools/decrypt-lib.js"></script>
<script src="../tools/config-loader.js"></script>
<script src="../tools/lang-switch.js"></script>


<script>
  // å…¨å±€çŠ¶æ€
  let currentUserConversations = [];

  /**
   * è·å–å½“å‰è¯­è¨€ç¯å¢ƒä¸‹çš„æ–‡æœ¬
   * å¦‚æœ val æ˜¯å¯¹è±¡ {cn:..., en:...} åˆ™è¿”å›å¯¹åº”è¯­è¨€æ–‡æœ¬
   * å¦åˆ™ç›´æ¥è¿”å› val
   */
  function getLocalizedText(val) {
    if (typeof val === 'object' && val !== null) {
      const lang = localStorage.getItem('app_lang') || 'cn';
      return val[lang] || val['cn'] || ''; // é»˜è®¤å›é€€åˆ°ä¸­æ–‡
    }
    return val;
  }

  /**
   * ä¿®å¤åçš„é‡è½½å‡½æ•°
   */
  window.reloadConfig = async function(lang) {
    try {
      // Chat çš„ç‰¹æ®Šé…ç½®ï¼š
      // baseName: 'config' (å¯¹åº” config.js / config.encrypted.js)
      // globalVar: 'ChatConfig'
      // encryptedVar: 'ENCRYPTED_CHAT_CONFIG'
      await UnifiedLoader.load('config', 'ChatConfig', 'ENCRYPTED_CHAT_CONFIG', lang);

      // åˆ·æ–°ç•Œé¢
      initApp();
      closeChat(); // åˆ‡æ¢è¯­è¨€åå…³é—­èŠå¤©çª—å£

    } catch (e) {
      console.error("Chat Config Load Failed:", e);
      alert("System Error: Config file missing.");
    }
  };


  // æ ¸å¿ƒåˆå§‹åŒ–é€»è¾‘
  (async function() {
    // ã€ä¿®å¤ã€‘é˜²æ­¢ç«æ€æ¡ä»¶ (å¦‚æœ lang-switch å·²ç»åŠ è½½äº†é…ç½®ï¼Œè¿™é‡Œå°±ä¸å†é‡å¤åŠ è½½)
    if (!window.ChatConfig) {
      const currentLang = localStorage.getItem('app_lang') || 'cn';
      await window.reloadConfig(currentLang);
    } else {
      // å¦‚æœå·²ç»åŠ è½½äº†ï¼Œç›´æ¥åˆå§‹åŒ– UI
      initApp();
    }
  })();

  // åº”ç”¨åˆå§‹åŒ–
  function initApp() {
    const currentUserId = sessionStorage.getItem('currentUser');
    // ä»é…ç½®ä¸­æŸ¥æ‰¾å½“å‰ç”¨æˆ·ï¼Œç¡®ä¿ displayName æ˜¯æœ€æ–°çš„ä¸”ç¬¦åˆå½“å‰è¯­è¨€
    const userAccount = ChatConfig.accounts.find(acc => acc.id === currentUserId);

    if (!userAccount) {
      window.location.href = 'index.html';
      return;
    }

    // 1. è®¾ç½®ç”¨æˆ·å¤´åƒå’Œåå­—
    const displayName = getLocalizedText(userAccount.displayName);
    document.getElementById('currentUser').textContent = displayName;
    document.getElementById('myAvatar').textContent = displayName ? displayName[0].toUpperCase() : 'U';

    // 2. åŠ è½½å¯¹è¯æ•°æ®
    currentUserConversations = ChatConfig.conversations[currentUserId] || [];
    renderList();
  }


  // =======================
  // DOM å…ƒç´ å¼•ç”¨
  // =======================
  const modal = document.getElementById('passwordModal');
  const passInput = document.getElementById('passwordInput');
  const passError = document.getElementById('passwordError');
  const passHint = document.getElementById('passwordHint');
  let pendingConv = null;
  let pendingEl = null;

  // =======================
  // 1. æ¸²æŸ“å¯¹è¯åˆ—è¡¨
  // =======================
  function renderList() {
    const container = document.getElementById('conversationList');
    container.innerHTML = '';

    currentUserConversations.forEach(conv => {
      // ç¡®ä¿æœ‰æ¶ˆæ¯
      if (!conv.messages || conv.messages.length === 0) return;

      const lastMsg = conv.messages[conv.messages.length - 1];
      const el = document.createElement('div');
      el.className = 'conv-item';
      el.onclick = () => handleClick(conv, el);

      // æ—¶é—´å¤„ç†
      const timeDisplay = lastMsg.time ? lastMsg.time.split(' ')[0] : '';

      // é¢„è§ˆæ–‡æœ¬å¤„ç†
      let previewText = getLocalizedText(lastMsg.text);
      const lang = localStorage.getItem('app_lang') || 'cn';

      if (conv.security?.type === 'encrypted') {
        previewText = lang === 'cn' ? 'ğŸ”’ [åŠ å¯†æ¶ˆæ¯]' : 'ğŸ”’ [Encrypted Message]';
      }

      const convName = getLocalizedText(conv.conversationName);

      el.innerHTML = `
      <div class="conv-header">
        <span class="conv-title">${convName}</span>
        <span class="conv-time">${timeDisplay}</span>
      </div>
      <div class="conv-preview">${previewText}</div>
    `;
      container.appendChild(el);
    });
  }

  // 2. ç‚¹å‡»å¤„ç†
  function handleClick(conv, el) {
    if (conv.security && conv.security.type === 'encrypted') {
      showPasswordModal(conv, el);
    } else {
      openChat(conv, el);
    }
  }

  // 3. å¯†ç å¼¹çª—é€»è¾‘
  function showPasswordModal(conv, el) {
    pendingConv = conv;
    pendingEl = el;

    const convName = getLocalizedText(conv.conversationName);
    // è¿™é‡Œçš„æ ‡é¢˜å¯ä»¥æ˜¯é™æ€çš„ï¼Œå› ä¸ºç•Œé¢ä¸Šå·²ç»æœ‰äº†åŒè¯­æ ‡é¢˜
    // å¦‚æœæƒ³æŠŠä¼šè¯åä¹Ÿæ”¾è¿›å»ï¼š
    // document.getElementById('modalTitle').textContent = convName;
    // ä½†ä¸ºäº†ä¿ç•™åŒè¯­ç»“æ„ï¼Œå»ºè®®ä»…æ˜¾ç¤º "åŠ å¯†å¯¹è¯" æ ‡é¢˜ï¼Œæˆ–è€…åªåŠ¨æ€ä¿®æ”¹å‰¯æ ‡é¢˜

    passInput.value = '';
    passError.style.display = 'none';
    passHint.style.display = 'none';
    modal.style.display = 'flex';
    passInput.focus();
  }

  document.getElementById('cancelPasswordBtn').onclick = () => {
    modal.style.display = 'none';
    pendingConv = null;
  };

  document.getElementById('showHintBtn').onclick = () => {
    if (pendingConv) {
      const hintText = getLocalizedText(pendingConv.security.hint) || (localStorage.getItem('app_lang')==='cn' ? "æ— æç¤º" : "No hint");
      passHint.textContent = "ğŸ’¡ " + hintText;
      passHint.style.display = 'block';
    }
  };

  const confirmUnlock = () => {
    if (!pendingConv) return;
    // å¯†ç æ¯”å¯¹é€šå¸¸ä¸éœ€è¦å¤šè¯­è¨€å¤„ç†ï¼Œç›´æ¥æ¯”å¯¹å­—ç¬¦ä¸²
    if (passInput.value === pendingConv.security.password) {
      modal.style.display = 'none';
      openChat(pendingConv, pendingEl);
      pendingConv = null;
    } else {
      passError.style.display = 'block';
      passInput.select();
    }
  };

  document.getElementById('confirmPasswordBtn').onclick = confirmUnlock;
  passInput.addEventListener('keydown', e => { if(e.key === 'Enter') confirmUnlock(); });

  // 4. æ‰“å¼€èŠå¤©
  window.openChat = function(conv, el) {
    // æ¿€æ´»æ ·å¼
    document.querySelectorAll('.conv-item').forEach(i => i.classList.remove('active'));
    if(el) el.classList.add('active');

    // ç§»åŠ¨ç«¯å¤„ç†
    if(window.innerWidth <= 768) {
      document.getElementById('chatWindow').classList.add('active');
      document.querySelector('.mobile-only').style.display = 'block';
    }

    // æ›´æ–°å¤´éƒ¨
    document.getElementById('chatTitle').innerHTML = getLocalizedText(conv.conversationName);

    // æ¸²æŸ“æ¶ˆæ¯
    const msgList = document.getElementById('messageList');
    msgList.innerHTML = '';

    // è·å–å½“å‰ç”¨æˆ·çš„æ˜¾ç¤ºåï¼ˆç”¨äºåˆ¤æ–­å·¦å³æ°”æ³¡ï¼‰
    // æ³¨æ„ï¼šåœ¨å¤šè¯­è¨€æ¨¡å¼ä¸‹ï¼Œåˆ¤æ–­â€œæˆ‘æ˜¯è°â€æœ€å¥½ç”¨ ID åˆ¤æ–­ï¼Œä½†ç›®å‰ç»“æ„å¯èƒ½ä¸æ”¯æŒ msg.senderId
    // æ‰€ä»¥è¿™é‡Œåšä¸€ä¸ªç®€å•çš„å…¼å®¹ï¼š
    const currentUserId = sessionStorage.getItem('currentUser');
    const myAccount = ChatConfig.accounts.find(a => a.id === currentUserId);
    // è¿™é‡Œçš„ myName å¯èƒ½æ˜¯å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬éœ€è¦æ‹¿åˆ°å½“å‰è¯­è¨€ä¸‹çš„å­—ç¬¦ä¸²
    const myName = getLocalizedText(myAccount?.displayName);

    conv.messages.forEach(msg => {
      // æ–‡æœ¬æœ¬åœ°åŒ–
      const msgText = getLocalizedText(msg.text);
      const msgSender = getLocalizedText(msg.sender);

      // ç³»ç»Ÿæ¶ˆæ¯
      if (msg.type === 'system') {
        const sysEl = document.createElement('div');
        sysEl.className = 'system-message-row';
        sysEl.innerHTML = `<span class="system-pill">${msgText}</span>`;
        msgList.appendChild(sysEl);
        return;
      }

      // åˆ¤æ–­æ˜¯å¦æ˜¯â€œæˆ‘â€
      // é€»è¾‘å‡çº§ï¼šé™¤äº†å…¨ååŒ¹é…ï¼Œä¹Ÿå¯ä»¥ç®€å•åŒ¹é…â€œæˆ‘â€è¿™ä¸ªå­—ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
      const isMe = (msgSender === myName) || (msgSender === 'æˆ‘') || (msgSender === 'Me');

      const row = document.createElement('div');
      row.className = `message-row ${isMe ? 'me' : 'other'}`;

      // æ—¶é—´å¤„ç†
      const timeStr = msg.time ? (msg.time.split(' ')[1] || msg.time) : '';

      row.innerHTML = `
      <div class="bubble">
        ${msgText}
      </div>
      <div class="message-meta">
        ${isMe ? '' : msgSender + ' Â· '} ${timeStr}
      </div>
    `;
      msgList.appendChild(row);
    });

    msgList.scrollTop = msgList.scrollHeight;
  }

  window.closeChat = function() {
    document.getElementById('chatWindow').classList.remove('active');
  }

  window.logout = function() {
    sessionStorage.clear();
    window.location.href = 'index.html';
  }

</script>
</body>
</html>