<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™»å½• - å¼‚è±¡ä¸­å­¦å­¦ç”Ÿå®åé€šè®¯ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="chat-style.css">
</head>
<body>

<div class="login-wrapper">

  <div class="login-brand">
    <div class="brand-title">
      <span class="lang-cn-only">å¼‚è±¡ä¸­å­¦<br>å­¦ç”Ÿå®åé€šè®¯ç³»ç»Ÿ</span>
      <span class="lang-en-only">Anomaly High<br>Communication System</span>
    </div>

    <div class="brand-desc" style="font-size: 0.95rem; opacity: 0.85; margin-top: 1.5rem; line-height: 1.6;">
      <p>
        <span class="lang-cn-only">ğŸ›¡ï¸ æœ¬ç³»ç»Ÿé‡‡ç”¨å®åè®¤è¯ï¼Œæ‰€æœ‰èŠå¤©è®°å½•å°†è¢«ä¿å­˜</span>
        <span class="lang-en-only">ğŸ›¡ï¸ Real-name authentication required. Records are archived.</span>
      </p>
      <p>
        <span class="lang-cn-only">âš ï¸ è¯·è‡ªè§‰éµå®ˆã€Šå­¦ç”Ÿç½‘ç»œè¡Œä¸ºç®¡ç†æ¡ä¾‹ã€‹</span>
        <span class="lang-en-only">âš ï¸ Please comply with the Cyber Conduct Regulations.</span>
      </p>
      <p style="margin-top: 1rem; font-size: 0.85rem; opacity: 0.7;">
        <span class="lang-cn-only">ç³»ç»Ÿç‰ˆæœ¬ï¼šv2.3.1 | æŠ€æœ¯æ”¯æŒï¼šæ ¡ä¿¡æ¯ä¸­å¿ƒ</span>
        <span class="lang-en-only">Ver 2.3.1 | Powered by IT Center</span>
      </p>
    </div>
  </div>

  <div class="login-form-container">

    <div class="lang-switch-wrapper">
      <select class="lang-selector">
        <option value="cn">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
      </select>
    </div>

    <div style="width: 100%; max-width: 360px; padding: 2rem;">
      <h2 style="margin-bottom: 2rem; font-size: 1.8rem; font-weight: 700;">
        <span class="lang-cn-only">è´¦å·ç™»å½•</span>
        <span class="lang-en-only">Student Login</span>
      </h2>

      <form id="loginForm">
        <div style="margin-bottom: 1.5rem;">
          <label style="display:block; margin-bottom:0.5rem; font-weight:600; color:var(--text-muted); font-size:0.9rem;">
            <span class="lang-cn-only">è´¦å·</span>
            <span class="lang-en-only">Username / ID</span>
          </label>
          <input type="text" id="username" class="input-field i18n-attr" style="margin:0"
                 required
                 data-attr="placeholder"
                 data-cn="è¯·è¾“å…¥æ ¡å›­è´¦å·"
                 data-en="Enter Student ID"
                 placeholder="è¯·è¾“å…¥æ ¡å›­è´¦å·">
        </div>

        <div style="margin-bottom: 2rem;">
          <label style="display:block; margin-bottom:0.5rem; font-weight:600; color:var(--text-muted); font-size:0.9rem;">
            <span class="lang-cn-only">å¯†ç </span>
            <span class="lang-en-only">Password</span>
          </label>
          <div style="position: relative;">
            <input type="password" id="password" class="input-field i18n-attr" style="margin:0; padding-right: 3rem;"
                   required
                   data-attr="placeholder"
                   data-cn="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                   data-en="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                   placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">

            <button type="button" id="togglePassword" style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 0.25rem; display: flex; align-items: center; justify-content: center; transition: color 0.2s;" title="Toggle Password">
              <svg id="eyeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </button>
          </div>
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1rem;">
          <span class="lang-cn-only">è¿›å…¥èŠå¤©</span>
          <span class="lang-en-only">Enter Chat</span>
        </button>

        <div id="errorMsg" style="display:none; margin-top:1rem; padding:0.75rem; background:#fef2f2; color:#ef4444; border-radius:0.5rem; text-align:center; font-size:0.9rem;">
          <span class="lang-cn-only">è´¦å·æˆ–å¯†ç é”™è¯¯</span>
          <span class="lang-en-only">Invalid username or password</span>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="../tools/decrypt-lib.js"></script>
<script src="../tools/config-loader.js"></script>
<script src="../tools/lang-switch.js"></script>

<script>
  /**
   * å®šä¹‰é…ç½®é‡è½½å‡½æ•° (ä¾› lang-switch.js è°ƒç”¨)
   */
  window.reloadConfig = async function(lang) {
    try {
      await UnifiedLoader.load(
              'config',               // baseName
              'ChatConfig',           // globalVar
              'ENCRYPTED_CHAT_CONFIG',// encryptedVar
              lang                    // lang
      );
    } catch (e) {
      console.error("Login Config Load Failed:", e);
    }
  };

  // ============================================================
  // ã€ä¿®å¤ 1ã€‘ç«‹å³ç»‘å®šäº‹ä»¶ï¼Œç§»é™¤ async ä¾èµ–
  // ============================================================
  const loginForm = document.getElementById('loginForm');
  if (loginForm) {
    loginForm.addEventListener('submit', function(e) {
      e.preventDefault(); // æ ¸å¿ƒï¼šç«‹å³é˜»æ­¢é»˜è®¤åˆ·æ–°è¡Œä¸º

      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value;
      const err = document.getElementById('errorMsg');

      // é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿é…ç½®å·²åŠ è½½
      if (!window.ChatConfig || !window.ChatConfig.accounts) {
        // æ ¹æ®å½“å‰è¯­è¨€æç¤º
        const isEn = localStorage.getItem('app_lang') === 'en';
        alert(isEn ? "System initializing... please wait." : "ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨å€™...");
        return;
      }

      const account = window.ChatConfig.accounts.find(acc => acc.id === user && acc.password === pass);

      if (account) {
        sessionStorage.setItem('currentUser', account.id);

        // å¤„ç†æ˜¾ç¤ºå (å…¼å®¹å¯¹è±¡å‹å’Œå­—ç¬¦ä¸²å‹)
        let displayName = account.displayName;
        if (typeof displayName === 'object' && displayName !== null) {
          const lang = localStorage.getItem('app_lang') || 'cn';
          displayName = displayName[lang] || displayName['cn'] || user;
        }

        sessionStorage.setItem('displayName', displayName);
        window.location.href = 'chat.html';
      } else {
        err.style.display = 'block';
        setTimeout(() => err.style.display = 'none', 3000);
      }
    });
  }

  // ============================================================
  // åˆå§‹åŒ–é€»è¾‘
  // ============================================================
  (async function() {
    // ã€ä¿®å¤ 2ã€‘é¿å…ç«æ€ï¼šå¦‚æœé…ç½®å·²è¢« lang-switch åŠ è½½ï¼Œåˆ™è·³è¿‡
    if (!window.ChatConfig) {
      const currentLang = localStorage.getItem('app_lang') || 'cn';
      await window.reloadConfig(currentLang);
    }

    // 2. å¯†ç æ˜¾ç¤º/éšè—åˆ‡æ¢ (UI é€»è¾‘æ”¾åœ¨è¿™é‡Œæ²¡é—®é¢˜)
    const passwordInput = document.getElementById('password');
    const toggleBtn = document.getElementById('togglePassword');
    const eyeIcon = document.getElementById('eyeIcon');

    if (toggleBtn) {
      toggleBtn.addEventListener('click', function() {
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          eyeIcon.innerHTML = `<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>`;
          toggleBtn.style.color = '#7c3aed';
        } else {
          passwordInput.type = 'password';
          eyeIcon.innerHTML = `<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>`;
          toggleBtn.style.color = 'var(--text-muted)';
        }
      });
    }
  })();
</script>
</body>
</html>