<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANOMALY: TERMINAL_ACCESS</title>
    <style>
        /* ===========================================
           ROOT & RESET
           =========================================== */
        :root {
            --bg-dark: #050508;
            --terminal-bg: #0a0c0f;
            --panel-bg: #080a0d;
            --border-color: #1a2a1a;
            --text-primary: #00ff41;
            --text-dim: #008f24;
            --text-muted: #004d14;
            --text-white: #c0c0c0;
            --accent-cyan: #00f3ff;
            --accent-red: #ff3333;
            --accent-yellow: #ffcc00;
            --font-mono: 'Consolas', 'Courier New', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg-dark);
            font-family: var(--font-mono);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* ===========================================
           CRT OVERLAY EFFECTS
           =========================================== */
        .crt-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background:
                    linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                    linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.03));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .vignette {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(ellipse at center, transparent 60%, rgba(0,0,0,0.6) 100%);
            pointer-events: none;
            z-index: 999;
        }

        /* ===========================================
           MAIN LAYOUT (7:3)
           =========================================== */
        .game-container {
            display: flex;
            height: 100vh;
            padding: 20px;
            gap: 15px;
        }

        /* ===========================================
           TERMINAL PANEL (70%)
           =========================================== */
        .terminal-panel {
            flex: 7;
            display: flex;
            flex-direction: column;
            background: var(--terminal-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .terminal-header {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            background: linear-gradient(180deg, #0f1a0f 0%, #0a0f0a 100%);
            border-bottom: 1px solid var(--border-color);
            gap: 15px;
        }

        .terminal-dots {
            display: flex;
            gap: 6px;
        }

        .terminal-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .terminal-dot.red { background: #ff5f56; }
        .terminal-dot.yellow { background: #ffbd2e; }
        .terminal-dot.green { background: #27ca40; }

        .terminal-title {
            font-size: 12px;
            color: var(--text-dim);
            letter-spacing: 2px;
        }

        .terminal-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .terminal-output {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
        }

        .terminal-output::-webkit-scrollbar {
            width: 6px;
        }
        .terminal-output::-webkit-scrollbar-track {
            background: var(--terminal-bg);
        }
        .terminal-output::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        /* Output line styles */
        .output-line {
            margin-bottom: 2px;
            word-wrap: break-word;
        }
        .output-line.system { color: var(--text-dim); }
        .output-line.error { color: var(--accent-red); }
        .output-line.success { color: #33ff33; }
        .output-line.info { color: var(--accent-cyan); }
        .output-line.warning { color: var(--accent-yellow); }
        .output-line.file-content {
            color: var(--text-white);
            padding-left: 10px;
            border-left: 2px solid var(--border-color);
            margin: 5px 0;
        }
        .output-line.ascii-art {
            color: var(--text-primary);
            white-space: pre;
            font-size: 10px;
            line-height: 1.2;
        }

        /* Directory listing */
        .dir-listing {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 5px;
            margin: 10px 0;
        }
        .dir-item {
            padding: 3px 8px;
            border-radius: 2px;
        }
        .dir-item.folder { color: var(--accent-cyan); }
        .dir-item.folder::before { content: "ğŸ“ "; }
        .dir-item.file { color: var(--text-white); }
        .dir-item.file::before { content: "ğŸ“„ "; }
        .dir-item.encrypted { color: var(--accent-yellow); }
        .dir-item.encrypted::before { content: "ğŸ”’ "; }
        .dir-item.target { color: #ff66ff; }
        .dir-item.target::before { content: "â­ "; }

        /* Input area */
        .terminal-input-area {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0, 20, 0, 0.3);
            border-top: 1px solid var(--border-color);
        }

        .prompt {
            color: var(--accent-cyan);
            margin-right: 10px;
            white-space: nowrap;
        }

        #terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            caret-color: var(--text-primary);
        }

        .cursor-blink {
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        /* ===========================================
           MANUAL PANEL (30%)
           =========================================== */
        .manual-panel {
            flex: 3;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .manual-header {
            padding: 12px 15px;
            background: linear-gradient(180deg, #0f1a0f 0%, #0a0f0a 100%);
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .manual-header h2 {
            font-size: 14px;
            letter-spacing: 3px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .manual-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 12px;
        }

        .manual-section {
            margin-bottom: 20px;
        }

        .manual-section h3 {
            color: var(--accent-cyan);
            font-size: 11px;
            letter-spacing: 2px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed var(--border-color);
        }

        .cmd-list {
            list-style: none;
        }

        .cmd-list li {
            margin-bottom: 8px;
            padding-left: 10px;
            border-left: 2px solid var(--border-color);
        }

        .cmd-name {
            color: var(--text-primary);
            font-weight: bold;
        }

        .cmd-desc {
            color: var(--text-muted);
            font-size: 11px;
        }

        .objective-box {
            background: rgba(255, 50, 50, 0.1);
            border: 1px solid rgba(255, 50, 50, 0.3);
            padding: 12px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .objective-box .target-file {
            color: var(--accent-red);
            font-size: 14px;
            font-weight: bold;
            margin-top: 5px;
            text-shadow: 0 0 10px rgba(255, 50, 50, 0.5);
        }

        .lang-switch {
            position: absolute;
            top: 25px;
            right: 40px;
            font-size: 12px;
            color: var(--text-dim);
            cursor: pointer;
            z-index: 100;
        }
        .lang-switch:hover { color: var(--text-primary); }
        .lang-switch span.active { color: var(--text-primary); }

        /* ===========================================
           MATRIX MINI-GAME (Embedded)
           =========================================== */
        .matrix-container {
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 50, 50, 0.2);
            border: 1px solid var(--accent-cyan);
            border-radius: 4px;
        }

        .matrix-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .matrix-level {
            color: var(--accent-cyan);
            font-size: 12px;
            letter-spacing: 2px;
        }

        .matrix-progress {
            color: var(--text-dim);
            font-size: 12px;
        }

        .matrix-body {
            display: flex;
            gap: 30px;
            justify-content: center;
            align-items: flex-start;
        }

        .matrix-left {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sequence-display {
            text-align: center;
        }

        .sequence-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .sequence-boxes {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .seq-box {
            width: 36px;
            height: 36px;
            border: 1px solid var(--accent-red);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--accent-red);
            background: rgba(255, 50, 50, 0.1);
        }

        .seq-box.matched {
            background: var(--accent-red);
            color: #000;
        }

        .buffer-display {
            text-align: center;
        }

        .buffer-boxes {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .buf-box {
            width: 36px;
            height: 36px;
            border: 1px solid var(--text-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-primary);
            background: rgba(0, 255, 65, 0.05);
        }

        .buf-box.filled {
            border-color: var(--text-primary);
            background: rgba(0, 255, 65, 0.2);
        }

        .buf-box.overflow-warning {
            border-color: var(--accent-yellow);
            animation: pulse-warning 0.5s infinite;
        }

        @keyframes pulse-warning {
            50% { background: rgba(255, 200, 0, 0.3); }
        }

        .matrix-grid {
            display: grid;
            gap: 4px;
        }

        .matrix-cell {
            width: 44px;
            height: 44px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.15s ease;
            background: rgba(0, 20, 20, 0.5);
        }

        .matrix-cell:hover:not(.disabled):not(.selected) {
            border-color: var(--text-primary);
            background: rgba(0, 255, 65, 0.1);
        }

        .matrix-cell.active-zone {
            border-color: var(--accent-cyan);
            box-shadow: inset 0 0 15px rgba(0, 243, 255, 0.15);
        }

        .matrix-cell.selected {
            background: var(--text-primary);
            color: #000;
            cursor: default;
        }

        .matrix-cell.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .matrix-hint {
            text-align: center;
            margin-top: 15px;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ===========================================
           DOWNLOAD ANIMATION
           =========================================== */
        .download-progress {
            margin: 10px 0;
        }

        .progress-bar-container {
            background: var(--border-color);
            height: 20px;
            border-radius: 2px;
            overflow: hidden;
            margin: 5px 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--text-primary), var(--accent-cyan));
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 12px;
            color: var(--text-dim);
        }

        /* ===========================================
           SUCCESS SCREEN
           =========================================== */
        .success-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 10, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }

        .success-overlay.visible {
            display: flex;
        }

        .success-title {
            font-size: 48px;
            color: #33ff33;
            text-shadow: 0 0 30px #33ff33, 0 0 60px #33ff33;
            letter-spacing: 10px;
            margin-bottom: 20px;
            animation: glowPulse 2s ease-in-out infinite;
        }

        .success-subtitle {
            font-size: 16px;
            color: var(--text-dim);
            letter-spacing: 5px;
        }

        @keyframes glowPulse {
            0%, 100% { text-shadow: 0 0 30px #33ff33, 0 0 60px #33ff33; }
            50% { text-shadow: 0 0 50px #33ff33, 0 0 100px #33ff33, 0 0 150px #33ff33; }
        }

        /* ===========================================
           LANGUAGE TOGGLE
           =========================================== */
        body.lang-en .lang-cn-only { display: none !important; }
        body.lang-cn .lang-en-only { display: none !important; }

        /* ===========================================
           RESPONSIVE
           =========================================== */
        @media (max-width: 1000px) {
            .game-container {
                flex-direction: column;
            }
            .terminal-panel, .manual-panel {
                flex: none;
            }
            .terminal-panel {
                height: 60vh;
            }
            .manual-panel {
                height: 35vh;
            }
        }
    </style>
</head>
<body class="lang-cn">

<div class="crt-overlay"></div>
<div class="vignette"></div>

<div class="lang-switch" onclick="toggleLanguage()">
    [ <span id="btn-cn" class="active">CN</span> / <span id="btn-en">EN</span> ]
</div>

<div class="game-container">
    <div class="terminal-panel">
        <div class="terminal-header">
            <div class="terminal-dots">
                <span class="terminal-dot red"></span>
                <span class="terminal-dot yellow"></span>
                <span class="terminal-dot green"></span>
            </div>
            <span class="terminal-title">
                    <span class="lang-cn-only">è¿œç¨‹ç»ˆç«¯ - å·²è¿æ¥</span>
                    <span class="lang-en-only">REMOTE TERMINAL - CONNECTED</span>
                </span>
        </div>
        <div class="terminal-body">
            <div class="terminal-output" id="terminal-output"></div>
            <div class="terminal-input-area">
                <span class="prompt" id="prompt">guest@server:/$</span>
                <input type="text" id="terminal-input" autocomplete="off" autofocus>
            </div>
        </div>
    </div>

    <div class="manual-panel">
        <div class="manual-header">
            <h2>
                <span class="lang-cn-only">æ“ä½œæ‰‹å†Œ</span>
                <span class="lang-en-only">OPERATOR MANUAL</span>
            </h2>
        </div>
        <div class="manual-content">
            <div class="manual-section">
                <h3>
                    <span class="lang-cn-only">â–¸ å¯ç”¨æŒ‡ä»¤</span>
                    <span class="lang-en-only">â–¸ COMMANDS</span>
                </h3>
                <ul class="cmd-list">
                    <li>
                        <span class="cmd-name">where</span><br>
                        <span class="cmd-desc lang-cn-only">æ˜¾ç¤ºå½“å‰æ‰€åœ¨ä½ç½®</span>
                        <span class="cmd-desc lang-en-only">Show current location</span>
                    </li>
                    <li>
                        <span class="cmd-name">look</span><br>
                        <span class="cmd-desc lang-cn-only">æŸ¥çœ‹å½“å‰ç›®å½•å†…å®¹</span>
                        <span class="cmd-desc lang-en-only">See what's here</span>
                    </li>
                    <li>
                        <span class="cmd-name">open &lt;name&gt;</span><br>
                        <span class="cmd-desc lang-cn-only">æ‰“å¼€æ–‡ä»¶å¤¹æˆ–é¢„è§ˆæ–‡ä»¶</span>
                        <span class="cmd-desc lang-en-only">Open folder or preview file</span>
                    </li>
                    <li>
                        <span class="cmd-name">back</span><br>
                        <span class="cmd-desc lang-cn-only">è¿”å›ä¸Šçº§ç›®å½•</span>
                        <span class="cmd-desc lang-en-only">Return to parent directory</span>
                    </li>
                    <li>
                        <span class="cmd-name">download &lt;file&gt;</span><br>
                        <span class="cmd-desc lang-cn-only">ä¸‹è½½æŒ‡å®šæ–‡ä»¶</span>
                        <span class="cmd-desc lang-en-only">Download specified file</span>
                    </li>
                    <li>
                        <span class="cmd-name">decrypt &lt;name&gt;</span><br>
                        <span class="cmd-desc lang-cn-only">è§£å¯†åŠ å¯†çš„æ–‡ä»¶å¤¹</span>
                        <span class="cmd-desc lang-en-only">Decrypt encrypted folder</span>
                    </li>
                    <li>
                        <span class="cmd-name">clear</span><br>
                        <span class="cmd-desc lang-cn-only">æ¸…ç©ºç»ˆç«¯å±å¹•</span>
                        <span class="cmd-desc lang-en-only">Clear terminal screen</span>
                    </li>
                    <li>
                        <span class="cmd-name">help</span><br>
                        <span class="cmd-desc lang-cn-only">æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯</span>
                        <span class="cmd-desc lang-en-only">Show help information</span>
                    </li>
                </ul>
            </div>

            <div class="manual-section">
                <h3>
                    <span class="lang-cn-only">â–¸ ä»»åŠ¡ç›®æ ‡</span>
                    <span class="lang-en-only">â–¸ OBJECTIVE</span>
                </h3>
                <div class="objective-box">
                    <span class="lang-cn-only">å®šä½å¹¶ä¸‹è½½æœºå¯†æ–‡ä»¶:</span>
                    <span class="lang-en-only">Locate and download:</span>
                    <div class="target-file">SHADOW_LEDGER_FINAL.dat</div>
                </div>
            </div>

            <div class="manual-section">
                <h3>
                    <span class="lang-cn-only">â–¸ æç¤º</span>
                    <span class="lang-en-only">â–¸ TIPS</span>
                </h3>
                <p style="color: var(--text-muted); font-size: 11px; line-height: 1.6;">
                    <span class="lang-cn-only">â€¢ æŒ‰ TAB é”®å¯è‡ªåŠ¨è¡¥å…¨<br>â€¢ æœºå¯†æ–‡ä»¶å¯èƒ½è¢«åŠ å¯†ä¿æŠ¤<br>â€¢ æ³¨æ„æŸ¥çœ‹æ—¥å¿—å¯»æ‰¾çº¿ç´¢</span>
                    <span class="lang-en-only">â€¢ Press TAB to auto-complete<br>â€¢ Files may be encrypted<br>â€¢ Check logs for clues</span>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="success-overlay" id="success-overlay">
    <div class="success-title">
        <span class="lang-cn-only">ä»»åŠ¡å®Œæˆ</span>
        <span class="lang-en-only">MISSION COMPLETE</span>
    </div>
    <div class="success-subtitle">
        <span class="lang-cn-only">[ æ•°æ®å·²å®‰å…¨è·å– ]</span>
        <span class="lang-en-only">[ DATA SECURED ]</span>
    </div>
</div>

<script>
    // ===========================================
    // LANGUAGE SYSTEM
    // ===========================================
    let currentLang = localStorage.getItem('app_lang') || 'cn';

    function setLanguage(lang) {
        currentLang = lang;
        document.body.classList.remove('lang-cn', 'lang-en');
        document.body.classList.add('lang-' + lang);
        localStorage.setItem('app_lang', lang);
        document.getElementById('btn-cn').classList.toggle('active', lang === 'cn');
        document.getElementById('btn-en').classList.toggle('active', lang === 'en');
    }

    function toggleLanguage() {
        setLanguage(currentLang === 'cn' ? 'en' : 'cn');
    }

    function t(cnText, enText) {
        return currentLang === 'cn' ? cnText : enText;
    }

    // Initialize language
    setLanguage(currentLang);

    // ===========================================
    // FILE SYSTEM DATA
    // ===========================================
    const FILE_SYSTEM = {
        '/': {
            type: 'folder',
            children: ['public', 'system', 'admin', 'temp']
        },
        '/public': {
            type: 'folder',
            children: ['welcome.txt']
        },
        '/public/welcome.txt': {
            type: 'file',
            content: {
                cn: `========================================
  æ¬¢è¿è®¿é—® ANOMALY æ¡£æ¡ˆæœåŠ¡å™¨
========================================

ä½ å·²æˆåŠŸå»ºç«‹è¿œç¨‹è¿æ¥ã€‚

æç¤º:
- ä½¿ç”¨ 'open <åç§°>' è¿›å…¥æ–‡ä»¶å¤¹æˆ–æŸ¥çœ‹æ–‡ä»¶
- ä½¿ç”¨ 'back' è¿”å›ä¸Šçº§ç›®å½•
- ä½¿ç”¨ 'download <æ–‡ä»¶>' ä¸‹è½½æ–‡ä»¶
- æŒ‰ TAB é”®å¯è‡ªåŠ¨è¡¥å…¨å‘½ä»¤æˆ–æ–‡ä»¶å

è­¦å‘Š: éƒ¨åˆ†ç›®å½•å¯èƒ½éœ€è¦è§£å¯†æ‰èƒ½è®¿é—®ã€‚

ç¥ä½ å¥½è¿ï¼Œç‰¹å·¥ã€‚`,
                en: `========================================
  WELCOME TO ANOMALY ARCHIVE SERVER
========================================

Remote connection established.

Tips:
- Use 'open <name>' to enter folders or view files
- Use 'back' to return to parent directory
- Use 'download <file>' to download files
- Press TAB to auto-complete

Warning: Some directories may require decryption.

Good luck, Agent.`
            }
        },
        '/system': {
            type: 'folder',
            children: ['logs']
        },
        '/system/logs': {
            type: 'folder',
            children: ['access.log']
        },
        '/system/logs/access.log': {
            type: 'file',
            content: {
                cn: `[2025-12-04 22:14:02] AUTH_SUCCESS: root@localhost
[2025-12-04 22:14:15] FILE_ACCESS: /admin/memo.txt
[2025-12-04 22:14:33] ACCESS_DENIED: /admin/restricted/
[2025-12-04 22:15:01] ENCRYPT_STATUS: restricted/ [LOCKED]
[2025-12-04 23:47:22] AUTH_SUCCESS: guest@remote
[2025-12-04 23:47:30] SESSION_START: å½“å‰ä¼šè¯

æç¤º: æœ‰äººè¯•å›¾è®¿é—® /admin/restricted/ ä½†è¢«æ‹’ç»äº†...`,
                en: `[2025-12-04 22:14:02] AUTH_SUCCESS: root@localhost
[2025-12-04 22:14:15] FILE_ACCESS: /admin/memo.txt
[2025-12-04 22:14:33] ACCESS_DENIED: /admin/restricted/
[2025-12-04 22:15:01] ENCRYPT_STATUS: restricted/ [LOCKED]
[2025-12-04 23:47:22] AUTH_SUCCESS: guest@remote
[2025-12-04 23:47:30] SESSION_START: current session

Hint: Someone tried to access /admin/restricted/ but was denied...`
            }
        },
        '/admin': {
            type: 'folder',
            children: ['memo.txt', 'restricted']
        },
        '/admin/memo.txt': {
            type: 'file',
            content: {
                cn: `è‡´ï¼šå…¨ä½“ç ”ç©¶å‘˜

æ ¸å¿ƒæ•°æ®æ–‡ä»¶å·²è½¬ç§»è‡³ restricted ç›®å½•ã€‚
è¯¥ç›®å½•å·²å¯ç”¨ä¸‰å±‚çŸ©é˜µåŠ å¯†ä¿æŠ¤ã€‚

å¦‚éœ€è®¿é—®ï¼Œè¯·ä½¿ç”¨ decrypt å‘½ä»¤è§£é”ã€‚

â€”â€” ç³»ç»Ÿç®¡ç†å‘˜`,
                en: `To: All Researchers

Core data files have been moved to restricted directory.
Triple-layer matrix encryption has been enabled.

Use decrypt command to unlock if access is needed.

â€”â€” System Administrator`
            }
        },
        '/admin/restricted': {
            type: 'folder',
            encrypted: true,
            children: ['SHADOW_LEDGER_FINAL.dat']
        },
        '/admin/restricted/SHADOW_LEDGER_FINAL.dat': {
            type: 'file',
            isTarget: true,
            content: {
                cn: `[ç»å¯† - åŸå§‹è´¢åŠ¡æ—¥å¿—]

è­¦å‘Šï¼šæ­¤æ–‡ä»¶ä¸æ ¡è‘£ä¼šå…¬å¼€çš„å¹´åº¦å®¡è®¡æŠ¥å‘Šå­˜åœ¨ä¸¥é‡å‡ºå…¥ã€‚
è®°å½•äº†å¤§é‡ä»¥â€œæ ¡èˆä¿®ç¼®â€å’Œâ€œç‰¹æ®Šç ”ç©¶â€ä¸ºåç›®çš„èµ„é‡‘æµå‘ä¸æ˜ç§äººè´¦æˆ·ã€‚
è¿™æ˜¯æ­éœ²å¼‚è±¡ä¸­å­¦é«˜å±‚è´ªæ±¡çš„å…³é”®è¯æ®ã€‚

> ä½¿ç”¨ 'download SHADOW_LEDGER_FINAL.dat' æå–è¯æ®ã€‚`,
                en: `[TOP SECRET - ORIGINAL FINANCIAL LOG]

WARNING: Significant discrepancies found against the Board's public audit.
Contains records of funds diverted to private accounts under "Renovation" and "Special Research".
This is the key evidence to expose the corruption of Anomaly High's administration.

> Use 'download SHADOW_LEDGER_FINAL.dat' to extract evidence.`
            }
        },
        '/temp': {
            type: 'folder',
            children: ['readme.txt']
        },
        '/temp/readme.txt': {
            type: 'file',
            content: {
                cn: `ä¸´æ—¶æ–‡ä»¶å¤¹ - æ— é‡è¦å†…å®¹

è¿™é‡Œä»€ä¹ˆéƒ½æ²¡æœ‰...æˆ–è€…æœ‰?

(æç¤º: æœºå¯†æ–‡ä»¶ä¸åœ¨è¿™é‡Œï¼Œè¯•è¯• /admin ç›®å½•)`,
                en: `Temporary folder - Nothing important here

Nothing to see... or is there?

(Hint: The secret file is not here, try /admin directory)`
            }
        }
    };

    // ===========================================
    // TERMINAL STATE
    // ===========================================
    let currentPath = '/';
    let commandHistory = [];
    let historyIndex = -1;
    let isDecrypted = false;
    let matrixGameActive = false;

    const outputEl = document.getElementById('terminal-output');
    const inputEl = document.getElementById('terminal-input');
    const promptEl = document.getElementById('prompt');

    // ===========================================
    // TERMINAL OUTPUT FUNCTIONS
    // ===========================================
    function print(text, className = '') {
        const line = document.createElement('div');
        line.className = 'output-line ' + className;
        line.innerHTML = text;
        outputEl.appendChild(line);
        outputEl.scrollTop = outputEl.scrollHeight;
    }

    function printAscii(text) {
        const line = document.createElement('div');
        line.className = 'output-line ascii-art';
        line.textContent = text;
        outputEl.appendChild(line);
        outputEl.scrollTop = outputEl.scrollHeight;
    }

    function clearOutput() {
        outputEl.innerHTML = '';
    }

    function updatePrompt() {
        const displayPath = currentPath === '/' ? '/' : currentPath;
        promptEl.textContent = `guest@server:${displayPath}$`;
    }

    // ===========================================
    // FILE SYSTEM FUNCTIONS
    // ===========================================
    function resolvePath(input) {
        if (input.startsWith('/')) return input;
        if (currentPath === '/') return '/' + input;
        return currentPath + '/' + input;
    }

    function getNode(path) {
        // Normalize path
        path = path.replace(/\/+/g, '/').replace(/\/$/, '') || '/';
        return FILE_SYSTEM[path];
    }

    function getCurrentFolder() {
        return getNode(currentPath);
    }

    // ===========================================
    // COMMAND HANDLERS
    // ===========================================
    function cmdWhere() {
        const displayPath = currentPath === '/' ? '/' : currentPath;
        print(t(`ğŸ“ å½“å‰ä½ç½®: ${displayPath}`, `ğŸ“ Current location: ${displayPath}`), 'info');
    }

    function cmdLook() {
        const folder = getCurrentFolder();
        
        if (!folder || !folder.children || folder.children.length === 0) {
            print(t('(è¿™é‡Œä»€ä¹ˆéƒ½æ²¡æœ‰)', '(Nothing here)'), 'system');
            return;
        }

        print(t('æ­£åœ¨æ‰«æå½“å‰ç›®å½•...', 'Scanning current directory...'), 'system');
        print('', '');

        folder.children.forEach(child => {
            const childPath = currentPath === '/' ? '/' + child : currentPath + '/' + child;
            const childNode = getNode(childPath);
            
            let icon = '';
            let label = '';
            let cssClass = '';
            
            if (childNode.type === 'folder') {
                if (childNode.encrypted && !isDecrypted) {
                    icon = 'ğŸ”’';
                    label = t('[å·²åŠ å¯†]', '[Encrypted]');
                    cssClass = 'warning';
                } else {
                    icon = 'ğŸ“';
                    label = t('[æ–‡ä»¶å¤¹]', '[Folder]');
                    cssClass = 'info';
                }
            } else {
                if (childNode.isTarget) {
                    icon = 'â­';
                    label = t('[ç›®æ ‡æ–‡ä»¶]', '[Target]');
                    cssClass = 'success';
                } else {
                    icon = 'ğŸ“„';
                    label = t('[æ–‡ä»¶]', '[File]');
                    cssClass = '';
                }
            }
            
            const name = child + (childNode.type === 'folder' ? '/' : '');
            print(`  ${icon} ${name}  <span style="opacity: 0.6">${label}</span>`, cssClass);
        });
        
        print('', '');
    }

    function cmdOpen(target) {
        if (!target) {
            print(t('[é”™è¯¯] ç”¨æ³•: open <ç›®å½•/æ–‡ä»¶å>', '[ERROR] Usage: open <folder/filename>'), 'error');
            return;
        }

        const fullPath = resolvePath(target.replace(/\/$/, ''));
        const node = getNode(fullPath);

        if (!node) {
            print(t(`[é”™è¯¯] æœªæ‰¾åˆ°: ${target}`, `[ERROR] Not found: ${target}`), 'error');
            return;
        }

        if (node.type === 'folder') {
            // Check encryption
            if (node.encrypted && !isDecrypted) {
                print(t('[æ‹’ç»è®¿é—®] ç›®å½•å·²åŠ å¯†', '[ACCESS DENIED] Directory is encrypted'), 'error');
                print(t(`ä½¿ç”¨ 'decrypt ${target}' è§£é”æ­¤ç›®å½•`, `Use 'decrypt ${target}' to unlock`), 'warning');
                return;
            }

            currentPath = fullPath;
            updatePrompt();
            print(t(`å·²è¿›å…¥: ${fullPath}`, `Entered: ${fullPath}`), 'system');

            // List contents
            const children = node.children;
            if (children && children.length > 0) {
                const listDiv = document.createElement('div');
                listDiv.className = 'dir-listing';

                children.forEach(child => {
                    const childPath = fullPath === '/' ? '/' + child : fullPath + '/' + child;
                    const childNode = getNode(childPath);
                    const item = document.createElement('div');
                    item.className = 'dir-item';

                    if (childNode.type === 'folder') {
                        item.classList.add(childNode.encrypted && !isDecrypted ? 'encrypted' : 'folder');
                    } else {
                        item.classList.add(childNode.isTarget ? 'target' : 'file');
                    }
                    item.textContent = child + (childNode.type === 'folder' ? '/' : '');
                    listDiv.appendChild(item);
                });

                outputEl.appendChild(listDiv);
                outputEl.scrollTop = outputEl.scrollHeight;
            } else {
                print(t('(ç©ºç›®å½•)', '(empty directory)'), 'system');
            }
        } else {
            // File - show content
            print(`â”€â”€ ${target} â”€â”€`, 'info');
            const content = node.content[currentLang] || node.content.cn;
            print(content.replace(/\n/g, '<br>'), 'file-content');
            print('â”€â”€ EOF â”€â”€', 'info');
        }
    }

    function cmdBack() {
        if (currentPath === '/') {
            print(t('[æç¤º] å·²åœ¨æ ¹ç›®å½•', '[INFO] Already at root'), 'system');
            return;
        }

        const parts = currentPath.split('/').filter(p => p);
        parts.pop();
        currentPath = '/' + parts.join('/') || '/';
        updatePrompt();
        print(t(`è¿”å›: ${currentPath}`, `Returned to: ${currentPath}`), 'system');
    }

    function cmdDownload(target) {
        if (!target) {
            print(t('[é”™è¯¯] ç”¨æ³•: download <æ–‡ä»¶å>', '[ERROR] Usage: download <filename>'), 'error');
            return;
        }

        const fullPath = resolvePath(target);
        const node = getNode(fullPath);

        if (!node) {
            print(t(`[é”™è¯¯] æœªæ‰¾åˆ°: ${target}`, `[ERROR] Not found: ${target}`), 'error');
            return;
        }

        if (node.type === 'folder') {
            print(t('[é”™è¯¯] æ— æ³•ä¸‹è½½æ–‡ä»¶å¤¹', '[ERROR] Cannot download a folder'), 'error');
            return;
        }

        // Check if it's in encrypted folder
        if (fullPath.includes('/restricted/') && !isDecrypted) {
            print(t('[æ‹’ç»è®¿é—®] æ–‡ä»¶ä½äºåŠ å¯†ç›®å½•ä¸­', '[ACCESS DENIED] File is in encrypted directory'), 'error');
            return;
        }

        // Start download animation
        playDownloadAnimation(target, node.isTarget);
    }

    function playDownloadAnimation(filename, isTarget) {
        print(t('[ç³»ç»Ÿ] æ­£åœ¨åˆå§‹åŒ–å®‰å…¨ä¼ è¾“...', '[SYSTEM] Initializing secure transfer...'), 'system');

        const progressDiv = document.createElement('div');
        progressDiv.className = 'download-progress';
        progressDiv.innerHTML = `
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="dl-progress"></div>
                </div>
                <div class="progress-text" id="dl-text">0%</div>
            `;
        outputEl.appendChild(progressDiv);
        outputEl.scrollTop = outputEl.scrollHeight;

        const progressBar = document.getElementById('dl-progress');
        const progressText = document.getElementById('dl-text');

        const stages = [
            { pct: 25, text: { cn: 'å»ºç«‹åŠ å¯†éš§é“...', en: 'Establishing encrypted tunnel...' } },
            { pct: 50, text: { cn: 'ç»•è¿‡é˜²ç«å¢™...', en: 'Bypassing firewall...' } },
            { pct: 75, text: { cn: 'æ£€æµ‹åˆ°è¿½è¸ªç¨‹åºï¼Œè§„é¿ä¸­...', en: 'Tracker detected, evading...' } },
            { pct: 100, text: { cn: 'ä¼ è¾“å®Œæˆ', en: 'Transfer complete' } }
        ];

        let stageIndex = 0;

        const interval = setInterval(() => {
            if (stageIndex >= stages.length) {
                clearInterval(interval);
                print('', '');
                print(t(`>> ${filename} å·²å®‰å…¨è·å–`, `>> ${filename} secured`), 'success');

                if (isTarget) {
                    print(t('>> æ–­å¼€è¿æ¥...', '>> Disconnecting...'), 'success');
                    setTimeout(() => {
                        triggerMissionComplete();
                    }, 1000);
                }
                return;
            }

            const stage = stages[stageIndex];
            progressBar.style.width = stage.pct + '%';
            progressText.textContent = `${stage.pct}% - ${stage.text[currentLang]}`;
            stageIndex++;
        }, 800);
    }

    function cmdDecrypt(target) {
        if (!target) {
            print(t('[é”™è¯¯] ç”¨æ³•: decrypt <ç›®å½•å>', '[ERROR] Usage: decrypt <folder>'), 'error');
            return;
        }

        const fullPath = resolvePath(target.replace(/\/$/, ''));
        const node = getNode(fullPath);

        if (!node) {
            print(t(`[é”™è¯¯] æœªæ‰¾åˆ°: ${target}`, `[ERROR] Not found: ${target}`), 'error');
            return;
        }

        if (!node.encrypted) {
            print(t('[æç¤º] æ­¤ç›®å½•æœªåŠ å¯†', '[INFO] Directory is not encrypted'), 'system');
            return;
        }

        if (isDecrypted) {
            print(t('[æç¤º] ç›®å½•å·²è§£å¯†', '[INFO] Directory already decrypted'), 'system');
            return;
        }

        // Start Matrix mini-game
        print(t('[ç³»ç»Ÿ] å¯åŠ¨è§£å¯†åè®®...', '[SYSTEM] Initiating decryption protocol...'), 'system');
        print(t('[ç³»ç»Ÿ] æ£€æµ‹åˆ° MATRIX_LOCK v3.0 - ä¸‰å±‚åŠ å¯†', '[SYSTEM] Detected MATRIX_LOCK v3.0 - Triple Layer'), 'warning');

        setTimeout(() => {
            startMatrixGame();
        }, 500);
    }

    function cmdHelp() {
        print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'info');
        print('â•‘         ' + t('å¯ç”¨å‘½ä»¤åˆ—è¡¨', 'AVAILABLE COMMANDS') + '            â•‘', 'info');
        print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'info');
        print('â•‘  where           ' + t('æ˜¾ç¤ºå½“å‰ä½ç½®', 'Show location') + '       â•‘', 'info');
        print('â•‘  look            ' + t('æŸ¥çœ‹ç›®å½•å†…å®¹', 'List contents') + '       â•‘', 'info');
        print('â•‘  open <name>     ' + t('æ‰“å¼€ç›®å½•/æ–‡ä»¶', 'Open folder/file') + '     â•‘', 'info');
        print('â•‘  back            ' + t('è¿”å›ä¸Šçº§ç›®å½•', 'Go to parent dir') + '     â•‘', 'info');
        print('â•‘  download <file> ' + t('ä¸‹è½½æ–‡ä»¶', 'Download file') + '         â•‘', 'info');
        print('â•‘  decrypt <name>  ' + t('è§£å¯†åŠ å¯†ç›®å½•', 'Decrypt folder') + '     â•‘', 'info');
        print('â•‘  clear           ' + t('æ¸…ç©ºå±å¹•', 'Clear screen') + '           â•‘', 'info');
        print('â•‘  help            ' + t('æ˜¾ç¤ºæ­¤å¸®åŠ©', 'Show this help') + '        â•‘', 'info');

        print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
    }

    function cmdClear() {
        clearOutput();
    }

    // ===========================================
    // MATRIX MINI-GAME (ä¿®æ”¹ç‰ˆï¼šè¿ç»­åŒ¹é… + è®¡æ—¶ + å¤±è´¥é€€å‡º)
    // ===========================================
    const MATRIX_LEVELS = [
        { gridSize: 4, seqLength: 3, bufferSize: 5, timeLimit: 15.0 },  // Level 1
        { gridSize: 5, seqLength: 4, bufferSize: 6, timeLimit: 12.0 },  // Level 2
        { gridSize: 6, seqLength: 5, bufferSize: 7, timeLimit: 10.0 }   // Level 3
    ];

    let matrixState = {
        currentLevel: 0,
        grid: [],
        targetSeq: [],
        buffer: [],
        bufferSize: 5,
        axis: 0,  // 0 = row, 1 = col
        lastIndex: { r: 0, c: -1 },
        selectedCells: new Set(),
        // æ–°å¢è®¡æ—¶å™¨çŠ¶æ€
        timerInterval: null,
        timeLeft: 0,
        hasStarted: false
    };

    function startMatrixGame() {
        matrixState.currentLevel = 0;
        matrixGameActive = true;
        inputEl.disabled = true;
        loadMatrixLevel(0);
    }

    function loadMatrixLevel(levelIndex) {
        const config = MATRIX_LEVELS[levelIndex];
        matrixState.currentLevel = levelIndex;
        matrixState.grid = [];
        matrixState.targetSeq = [];
        matrixState.buffer = [];
        matrixState.bufferSize = config.bufferSize;
        matrixState.axis = 0;
        matrixState.lastIndex = { r: 0, c: -1 };
        matrixState.selectedCells = new Set();

        // é‡ç½®è®¡æ—¶å™¨çŠ¶æ€
        matrixState.timeLeft = config.timeLimit;
        matrixState.hasStarted = false;
        if (matrixState.timerInterval) clearInterval(matrixState.timerInterval);

        // Generate grid with hex values
        const hexChars = ['1C', '55', '7A', 'BD', 'E9', 'FF'];

        for (let r = 0; r < config.gridSize; r++) {
            let row = [];
            for (let c = 0; c < config.gridSize; c++) {
                row.push(hexChars[Math.floor(Math.random() * hexChars.length)]);
            }
            matrixState.grid.push(row);
        }

        // Generate solvable sequence
        matrixState.targetSeq = generateSolvableSequence(
            matrixState.grid,
            config.seqLength,
            config.gridSize
        );

        renderMatrixUI();
    }

    function generateSolvableSequence(grid, seqLength, gridSize) {
        let sequence = [];
        let axis = 0;
        let currentRow = 0;
        let currentCol = -1;
        let usedCells = new Set();

        for (let i = 0; i < seqLength; i++) {
            let validCells = [];

            if (axis === 0) {
                for (let c = 0; c < gridSize; c++) {
                    const key = `${currentRow},${c}`;
                    if (!usedCells.has(key)) {
                        validCells.push({ r: currentRow, c: c, val: grid[currentRow][c] });
                    }
                }
            } else {
                for (let r = 0; r < gridSize; r++) {
                    const key = `${r},${currentCol}`;
                    if (!usedCells.has(key)) {
                        validCells.push({ r: r, c: currentCol, val: grid[r][currentCol] });
                    }
                }
            }

            if (validCells.length === 0) break;

            const pick = validCells[Math.floor(Math.random() * validCells.length)];
            sequence.push(pick.val);
            usedCells.add(`${pick.r},${pick.c}`);
            currentRow = pick.r;
            currentCol = pick.c;
            axis = 1 - axis;
        }

        return sequence;
    }

    // å¯åŠ¨è®¡æ—¶å™¨
    function startTimer() {
        if (matrixState.hasStarted) return;
        matrixState.hasStarted = true;

        const timerEl = document.getElementById('matrix-timer-val');

        matrixState.timerInterval = setInterval(() => {
            matrixState.timeLeft -= 0.1;
            if (timerEl) {
                timerEl.textContent = matrixState.timeLeft.toFixed(2);
            }

            if (matrixState.timeLeft <= 0) {
                clearInterval(matrixState.timerInterval);
                if (timerEl) timerEl.textContent = "0.00";
                matrixFailed(true); // true è¡¨ç¤ºè¶…æ—¶å¤±è´¥
            }
        }, 100);
    }

    function renderMatrixUI() {
        const config = MATRIX_LEVELS[matrixState.currentLevel];

        const container = document.createElement('div');
        container.className = 'matrix-container';
        container.id = 'matrix-container';

        // Header - åŠ å…¥è®¡æ—¶å™¨æ˜¾ç¤º
        const header = document.createElement('div');
        header.className = 'matrix-header';
        header.innerHTML = `
                <span class="matrix-level">${t('è§£å¯†å±‚çº§', 'DECRYPTION LAYER')} ${matrixState.currentLevel + 1}/3</span>
                <span style="color: #ff3333; font-weight: bold;">
                    T-MINUS: <span id="matrix-timer-val">${config.timeLimit.toFixed(2)}</span>s
                </span>
                <span class="matrix-progress">${config.gridSize}Ã—${config.gridSize} | ${t('åºåˆ—', 'SEQ')}: ${config.seqLength}</span>
            `;
        container.appendChild(header);

        // Body
        const body = document.createElement('div');
        body.className = 'matrix-body';

        // Left side
        const left = document.createElement('div');
        left.className = 'matrix-left';

        // Target sequence
        const seqDisplay = document.createElement('div');
        seqDisplay.className = 'sequence-display';
        seqDisplay.innerHTML = `<div class="sequence-label">${t('ç›®æ ‡åºåˆ—', 'TARGET SEQUENCE')}</div>`;
        const seqBoxes = document.createElement('div');
        seqBoxes.className = 'sequence-boxes';
        seqBoxes.id = 'target-seq-boxes';
        matrixState.targetSeq.forEach((val, i) => {
            const box = document.createElement('div');
            box.className = 'seq-box';
            box.textContent = val;
            box.dataset.index = i;
            seqBoxes.appendChild(box);
        });
        seqDisplay.appendChild(seqBoxes);
        left.appendChild(seqDisplay);

        // Buffer
        const bufDisplay = document.createElement('div');
        bufDisplay.className = 'buffer-display';
        bufDisplay.innerHTML = `<div class="sequence-label">${t('ç¼“å†²åŒº', 'BUFFER')} (${matrixState.bufferSize})</div>`;
        const bufBoxes = document.createElement('div');
        bufBoxes.className = 'buffer-boxes';
        bufBoxes.id = 'buffer-boxes';
        for (let i = 0; i < matrixState.bufferSize; i++) {
            const box = document.createElement('div');
            box.className = 'buf-box';
            box.dataset.index = i;
            bufBoxes.appendChild(box);
        }
        bufDisplay.appendChild(bufBoxes);
        left.appendChild(bufDisplay);

        body.appendChild(left);

        // Right side - Grid
        const gridDiv = document.createElement('div');
        gridDiv.className = 'matrix-grid';
        gridDiv.id = 'matrix-grid';
        gridDiv.style.gridTemplateColumns = `repeat(${config.gridSize}, 44px)`;

        matrixState.grid.forEach((row, r) => {
            row.forEach((val, c) => {
                const cell = document.createElement('div');
                cell.className = 'matrix-cell';
                cell.textContent = val;
                cell.dataset.r = r;
                cell.dataset.c = c;
                cell.onclick = () => handleMatrixClick(r, c, val, cell);
                gridDiv.appendChild(cell);
            });
        });

        body.appendChild(gridDiv);
        container.appendChild(body);

        const hint = document.createElement('div');
        hint.className = 'matrix-hint';
        hint.innerHTML = t(
            'è§„åˆ™: å¿…é¡»è¿ç»­åŒ¹é…ç›®æ ‡åºåˆ—ã€‚ç‚¹å‡»ç¬¬ä¸€ä¸ªæ–¹å—å¼€å§‹è®¡æ—¶ã€‚',
            'Rule: Match sequence continuously. Timer starts on first click.'
        );
        container.appendChild(hint);

        outputEl.appendChild(container);
        outputEl.scrollTop = outputEl.scrollHeight;

        updateMatrixHighlights();
    }

    function updateMatrixHighlights() {
        const cells = document.querySelectorAll('#matrix-grid .matrix-cell');
        cells.forEach(cell => {
            const r = parseInt(cell.dataset.r);
            const c = parseInt(cell.dataset.c);
            const key = `${r},${c}`;

            cell.classList.remove('active-zone', 'disabled');

            if (matrixState.selectedCells.has(key)) {
                return;
            }

            if (matrixState.lastIndex.c === -1) {
                if (r === 0) {
                    cell.classList.add('active-zone');
                } else {
                    cell.classList.add('disabled');
                }
            } else {
                if (matrixState.axis === 0) {
                    if (r === matrixState.lastIndex.r) cell.classList.add('active-zone');
                    else cell.classList.add('disabled');
                } else {
                    if (c === matrixState.lastIndex.c) cell.classList.add('active-zone');
                    else cell.classList.add('disabled');
                }
            }
        });

        const remaining = matrixState.bufferSize - matrixState.buffer.length;
        const bufBoxes = document.querySelectorAll('#buffer-boxes .buf-box');
        bufBoxes.forEach((box, i) => {
            if (i >= matrixState.buffer.length && remaining <= 2) {
                box.classList.add('overflow-warning');
            } else {
                box.classList.remove('overflow-warning');
            }
        });
    }

    function handleMatrixClick(r, c, val, cellElement) {
        if (!matrixGameActive) return;
        if (matrixState.selectedCells.has(`${r},${c}`)) return;
        if (!cellElement.classList.contains('active-zone')) return;

        // [ä¿®æ”¹ç‚¹] ç‚¹å‡»ç¬¬ä¸€ä¸ªæ–¹å—æ—¶å¼€å§‹è®¡æ—¶
        if (!matrixState.hasStarted) {
            startTimer();
        }

        // Add to buffer
        matrixState.buffer.push(val);
        matrixState.selectedCells.add(`${r},${c}`);
        cellElement.classList.add('selected');
        cellElement.classList.remove('active-zone');

        // Update buffer display
        const bufBoxes = document.querySelectorAll('#buffer-boxes .buf-box');
        const bufIndex = matrixState.buffer.length - 1;
        if (bufBoxes[bufIndex]) {
            bufBoxes[bufIndex].textContent = val;
            bufBoxes[bufIndex].classList.add('filled');
        }

        // Check sequence match
        const matchResult = checkSequenceMatch();

        // Update position for next move
        matrixState.lastIndex = { r: r, c: c };
        matrixState.axis = 1 - matrixState.axis;

        if (matchResult === 'WIN') {
            matrixLevelComplete();
            return;
        }

        // Check buffer overflow (only if not won yet)
        if (matrixState.buffer.length >= matrixState.bufferSize) {
            matrixFailed(false); // false è¡¨ç¤ºç¼“å†²åŒºæ»¡å¯¼è‡´çš„å¤±è´¥
            return;
        }

        updateMatrixHighlights();
    }

    // [ä¿®æ”¹ç‚¹] è¿ç»­åºåˆ—åŒ¹é…æ£€æŸ¥
    function checkSequenceMatch() {
        // å°†æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¿›è¡ŒåŒ¹é… (ä¾‹å¦‚ "7B,AA,FF")
        // è¿™æ ·å¯ä»¥ç¡®ä¿åŒ¹é…æ˜¯è¿ç»­çš„
        const targetStr = matrixState.targetSeq.join(',');
        const bufferStr = matrixState.buffer.join(',');

        // æ£€æŸ¥ target æ˜¯å¦åŒ…å«åœ¨ buffer ä¸­
        if (bufferStr.includes(targetStr)) {
            // æ‰¾åˆ°å®Œå…¨åŒ¹é…
            const seqBoxes = document.querySelectorAll('#target-seq-boxes .seq-box');
            seqBoxes.forEach(box => box.classList.add('matched'));
            return 'WIN';
        }

        // å¦‚æœæ²¡æœ‰å®Œå…¨åŒ¹é…ï¼Œæ£€æŸ¥å½“å‰ç¼“å†²åŒºçš„åç¼€æ˜¯å¦åŒ¹é…ç›®æ ‡çš„å‰ç¼€ï¼ˆç”¨äºè§†è§‰é«˜äº®è¿›åº¦ï¼‰
        // æ³¨æ„ï¼šè¿™åªæ˜¯è§†è§‰æ•ˆæœï¼Œé€»è¾‘åˆ¤æ–­å®Œå…¨ä¾èµ–ä¸Šé¢çš„ includes
        const seqBoxes = document.querySelectorAll('#target-seq-boxes .seq-box');
        // å…ˆé‡ç½®æ‰€æœ‰é«˜äº®
        seqBoxes.forEach(box => box.classList.remove('matched'));

        // ç®€å•çš„é«˜äº®é€»è¾‘ï¼šæ£€æŸ¥å½“å‰ buffer çš„æœ€åä¸€éƒ¨åˆ†æ˜¯å¦åŒ¹é… target çš„å¼€å¤´
        // ä¾‹å¦‚ Buffer: [4D, 7B, AA] Target: [7B, AA, 6C]
        // buffer åä¸¤ä½ [7B, AA] åŒ¹é… target å‰ä¸¤ä½
        let matchCount = 0;
        const targetLen = matrixState.targetSeq.length;
        const bufferLen = matrixState.buffer.length;

        for (let len = Math.min(targetLen, bufferLen); len > 0; len--) {
            const subBuffer = matrixState.buffer.slice(bufferLen - len);
            const subTarget = matrixState.targetSeq.slice(0, len);
            if (subBuffer.join(',') === subTarget.join(',')) {
                matchCount = len;
                break;
            }
        }

        for (let i = 0; i < matchCount; i++) {
            seqBoxes[i].classList.add('matched');
        }

        return 'CONTINUE';
    }

    function matrixLevelComplete() {
        // åœæ­¢è®¡æ—¶å™¨
        if (matrixState.timerInterval) clearInterval(matrixState.timerInterval);

        const container = document.getElementById('matrix-container');
        if (container) {
            container.style.borderColor = '#33ff33';
            container.style.boxShadow = '0 0 20px rgba(50, 255, 50, 0.3)';
        }

        print(t(`[æˆåŠŸ] ç¬¬ ${matrixState.currentLevel + 1} å±‚è§£å¯†å®Œæˆ!`,
            `[SUCCESS] Layer ${matrixState.currentLevel + 1} decrypted!`), 'success');

        setTimeout(() => {
            if (container) container.remove();

            if (matrixState.currentLevel < 2) {
                // Next level
                print(t('[ç³»ç»Ÿ] åŠ è½½ä¸‹ä¸€å±‚åŠ å¯†...', '[SYSTEM] Loading next encryption layer...'), 'system');
                setTimeout(() => {
                    loadMatrixLevel(matrixState.currentLevel + 1);
                }, 800);
            } else {
                // All complete!
                matrixGameComplete();
            }
        }, 1000);
    }

    // [ä¿®æ”¹ç‚¹] å¤±è´¥å¤„ç†é€»è¾‘ï¼šåœæ­¢è®¡æ—¶ï¼Œæ¸…ç†UIï¼Œæ¢å¤è¾“å…¥ï¼Œé€€å‡ºæ¸¸æˆ
    function matrixFailed(isTimeout) {
        // åœæ­¢è®¡æ—¶å™¨
        if (matrixState.timerInterval) clearInterval(matrixState.timerInterval);

        const container = document.getElementById('matrix-container');
        if (container) {
            container.style.borderColor = '#ff3333';
            container.style.boxShadow = '0 0 20px rgba(255, 50, 50, 0.3)';
        }

        const failMsg = isTimeout
            ? t('[å¤±è´¥] è¿æ¥è¶…æ—¶ - è¿½è¸ªç¨‹åºå·²é”å®š', '[FAILED] Connection Timeout - Trace complete')
            : t('[å¤±è´¥] ç¼“å†²åŒºæº¢å‡º - å“ˆå¸ŒéªŒè¯å¤±è´¥', '[FAILED] Buffer overflow - Hash mismatch');

        print(failMsg, 'error');

        setTimeout(() => {
            if (container) container.remove();

            // å®Œå…¨é€€å‡º Matrix æ¨¡å¼
            matrixGameActive = false;
            matrixState.hasStarted = false;

            // æ¢å¤ç»ˆç«¯è¾“å…¥
            inputEl.disabled = false;
            inputEl.focus();

            print(t('[è­¦å‘Š] å®‰å…¨åè®®è§¦å‘ï¼Œè¿æ¥å·²æ–­å¼€ã€‚', '[WARNING] Security protocol triggered. Connection dropped.'), 'warning');
            print(t("è¯·é‡æ–°è¾“å…¥ 'decrypt' å°è¯•å»ºç«‹æ–°è¿æ¥ã€‚", "Please re-enter 'decrypt' to attempt new connection."), 'system');

            updatePrompt();
        }, 1500);
    }

    function matrixGameComplete() {
        matrixGameActive = false;
        isDecrypted = true;
        inputEl.disabled = false;
        inputEl.focus();

        // Victory ASCII art
        print('', '');
        printAscii('â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“');
        printAscii('â–“â–“                                  â–“â–“');
        printAscii('â–“â–“     â–ˆâ–ˆ ACCESS GRANTED â–ˆâ–ˆ        â–“â–“');
        printAscii('â–“â–“                                  â–“â–“');
        printAscii('â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“');
        print('', '');
        print(t('[ç³»ç»Ÿ] restricted/ ç›®å½•å·²è§£é”', '[SYSTEM] restricted/ directory unlocked'), 'success');
        print(t("ä½¿ç”¨ 'open restricted' è¿›å…¥ç›®å½•", "Use 'open restricted' to enter directory"), 'info');
    }

    // ===========================================
    // MISSION COMPLETE (Updated for PostMessage)
    // ===========================================
    function triggerMissionComplete() {
        document.getElementById('success-overlay').classList.add('visible');

        // é€šçŸ¥çˆ¶é¡µé¢ (è§£å†³ SecurityError: Blocked a frame with origin "null")
        setTimeout(() => {
            console.log('[Terminal] Sending complete message to parent...');
            window.parent.postMessage({
                type: 'minigame-complete',
                result: { success: true }
            }, '*');
        }, 2000);
    }

    // ===========================================
    // TAB COMPLETION
    // ===========================================
    function getCompletions(input) {
        const parts = input.trim().split(/\s+/);
        const commands = ['where', 'look', 'open', 'back', 'download', 'decrypt', 'clear', 'help'];

        if (parts.length === 1) {
            // Complete command
            const partial = parts[0].toLowerCase();
            return commands.filter(cmd => cmd.startsWith(partial));
        } else if (parts.length === 2) {
            // Complete path/filename
            const cmd = parts[0].toLowerCase();
            const partial = parts[1].toLowerCase();
            const folder = getCurrentFolder();

            if (folder && folder.children) {
                return folder.children
                    .filter(name => name.toLowerCase().startsWith(partial))
                    .map(name => {
                        const fullPath = currentPath === '/' ? '/' + name : currentPath + '/' + name;
                        const node = getNode(fullPath);
                        return name + (node && node.type === 'folder' ? '/' : '');
                    });
            }
        }

        return [];
    }

    // ===========================================
    // COMMAND PARSER
    // ===========================================
    function executeCommand(input) {
        const trimmed = input.trim();
        if (!trimmed) return;

        // Echo command
        print(`<span style="color: var(--accent-cyan)">$</span> ${trimmed}`, '');

        // Add to history
        commandHistory.push(trimmed);
        historyIndex = commandHistory.length;

        const parts = trimmed.split(/\s+/);
        const cmd = parts[0].toLowerCase();
        const args = parts.slice(1).join(' ');

        switch (cmd) {
            case 'where':
                cmdWhere();
                break;
            case 'look':
                cmdLook();
                break;
            case 'open':
                cmdOpen(args);
                break;
            case 'back':
                cmdBack();
                break;
            case 'download':
                cmdDownload(args);
                break;
            case 'decrypt':
                cmdDecrypt(args);
                break;
            case 'clear':
                cmdClear();
                break;
            case 'help':
                cmdHelp();
                break;
            default:
                print(t(`[é”™è¯¯] æœªçŸ¥å‘½ä»¤: ${cmd}`, `[ERROR] Unknown command: ${cmd}`), 'error');
                print(t("è¾“å…¥ 'help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤", "Type 'help' for available commands"), 'system');
        }
    }

    // ===========================================
    // INPUT HANDLING
    // ===========================================
    inputEl.addEventListener('keydown', function(e) {
        if (matrixGameActive) {
            e.preventDefault();
            return;
        }

        if (e.key === 'Enter') {
            e.preventDefault();
            const cmd = inputEl.value;
            inputEl.value = '';
            executeCommand(cmd);
        } else if (e.key === 'Tab') {
            e.preventDefault();
            const completions = getCompletions(inputEl.value);

            if (completions.length === 1) {
                const parts = inputEl.value.trim().split(/\s+/);
                if (parts.length === 1) {
                    inputEl.value = completions[0] + ' ';
                } else {
                    inputEl.value = parts[0] + ' ' + completions[0];
                }
            } else if (completions.length > 1) {
                print(t('å¯é€‰: ', 'Options: ') + completions.join('  '), 'system');
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (historyIndex > 0) {
                historyIndex--;
                inputEl.value = commandHistory[historyIndex];
            }
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (historyIndex < commandHistory.length - 1) {
                historyIndex++;
                inputEl.value = commandHistory[historyIndex];
            } else {
                historyIndex = commandHistory.length;
                inputEl.value = '';
            }
        }
    });

    // Keep input focused
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.manual-panel') && !matrixGameActive) {
            inputEl.focus();
        }
    });

    // ===========================================
    // INITIALIZATION
    // ===========================================
    function init() {
        // Boot sequence
        printAscii('   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—');
        printAscii('  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•');
        printAscii('  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• ');
        printAscii('  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘    â•šâ–ˆâ–ˆâ•”â•  ');
        printAscii('  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   ');
        printAscii('  â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•   ');
        print('', '');
        print(t('[ç³»ç»Ÿ] è¿œç¨‹è¿æ¥å·²å»ºç«‹', '[SYSTEM] Remote connection established'), 'system');
        print(t('[ç³»ç»Ÿ] ç»ˆç«¯åˆå§‹åŒ–å®Œæˆ', '[SYSTEM] Terminal initialized'), 'system');
        print('', '');

        // Auto list root directory
        setTimeout(() => {
            print(t("æç¤º: è¾“å…¥ 'help' æŸ¥çœ‹å‘½ä»¤åˆ—è¡¨ï¼Œæˆ–ç›´æ¥æ¢ç´¢ç›®å½•",
                "Tip: Type 'help' for commands, or start exploring"), 'info');
            print('', '');

            const folder = getCurrentFolder();
            const listDiv = document.createElement('div');
            listDiv.className = 'dir-listing';

            folder.children.forEach(child => {
                const childPath = '/' + child;
                const childNode = getNode(childPath);
                const item = document.createElement('div');
                item.className = 'dir-item';
                item.classList.add(childNode.type === 'folder' ? 'folder' : 'file');
                item.textContent = child + (childNode.type === 'folder' ? '/' : '');
                listDiv.appendChild(item);
            });

            outputEl.appendChild(listDiv);
            outputEl.scrollTop = outputEl.scrollHeight;
        }, 500);

        updatePrompt();
        inputEl.focus();
    }

    // ===========================================
    // STARTUP LOGIC (Updated for PostMessage)
    // ===========================================

    // 1. ç›‘å¬æ¥è‡ªçˆ¶çº§ (minigame-manager) çš„åˆå§‹åŒ–æ¶ˆæ¯
    window.addEventListener('message', (event) => {
        const data = event.data;
        if (data && data.type === 'init') {
            console.log('[Terminal] Received init message:', data);

            // è®¾ç½®è¯­è¨€
            if (data.lang) {
                setLanguage(data.lang);
            }

            // å¯åŠ¨æ¸¸æˆ
            init();
        }
    });

    // 2. ç‹¬ç«‹è¿è¡Œå…¼å®¹æ€§ (å¦‚æœä½ ç›´æ¥æ‰“å¼€è¿™ä¸ªhtmlæ–‡ä»¶ï¼Œæ²¡æœ‰çˆ¶çº§ï¼Œè‡ªåŠ¨å¯åŠ¨)
    if (window.self === window.top) {
        console.log('[Terminal] Running standalone');
        init();
    }
</script>
</body>
</html>