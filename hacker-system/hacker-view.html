<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANOMALY: LIBRARY INFILTRATION</title>
    <link rel="stylesheet" href="hacker-style.css">
</head>
<body class="lang-cn">

<audio id="bgmAudio" src="../bgm/hacker.mp3" loop preload="auto"></audio>

<div class="monitor-wrapper">
    <div class="overlay-scanline"></div>
    <div class="overlay-vignette"></div>
    <div id="glitchLayer" class="glitch-overlay"></div>

    <!-- ä¿¡å·ä¸­æ–­è¿‡æ¸¡å±‚ -->
    <div id="signalLostLayer" class="signal-lost-layer hidden">
        <div class="static-noise"></div>
        <div class="signal-text">
            <div class="signal-icon">â—‰</div>
            <div class="signal-msg">NO SIGNAL</div>
            <div class="signal-code">ERR_CONNECTION_TERMINATED</div>
        </div>
        <div class="signal-bars">
            <span></span><span></span><span></span><span></span><span></span>
        </div>
    </div>

    <div class="monitor-header">
        <span>
            <span class="lang-en-only">CAM_04: LIBRARY_ARCHIVE</span>
            <span class="lang-cn-only">å®æ—¶ç›‘æ§æº: å›¾ä¹¦é¦†</span>
        </span>

        <div class="hacker-lang-switch" onclick="toggleLanguage()">
            [ <span id="btn-cn">CN</span> / <span id="btn-en">EN</span> ]
        </div>

        <!-- è°ƒè¯•æŒ‰é’®ï¼šä¸Šçº¿æ—¶æ³¨é‡Šæ‰å³å¯ -->
        <div class="debug-controls">
            <button onclick="window.gameEngine?.skipLevel()">[SKIP]</button>
        </div>

        <!-- ç©å®¶ç”¨ï¼šè·³è¿‡æ¸¸æˆæŒ‰é’® -->
        <div class="skip-game-btn" onclick="window.gameEngine?.showSkipConfirm()">
            <span class="skip-icon">â­</span>
            <span class="skip-text">
                <span class="lang-cn-only">è·³è¿‡æ¸¸æˆ</span>
                <span class="lang-en-only">SKIP GAME</span>
            </span>
        </div>

        <span id="clock" style="float: right">REC 00:00:00</span>
    </div>

    <div id="mapContainer" class="map-container">
        <svg id="svgLayer"></svg>
        <div id="entityLayer">
            <div id="thoughtBubble" class="thought-bubble hidden">
                <div id="thoughtText" class="thought-content"></div>
            </div>
        </div>
    </div>



    <div id="modalOverlay" class="modal-overlay hidden">
        <div class="modal-box">
            <h2 id="modalTitle" class="glitch-text">SYSTEM ACCESS GRANTED</h2>
            <div id="modalMsg"></div>
        </div>
    </div>
</div>

<div class="phone-terminal">
    <div class="phone-header">
        <span class="signal">ğŸ“¶ 5G</span>
            <span class="contact-name">
                 <span class="lang-en-only">ANONYMOUS</span>
                <span class="lang-cn-only">åŒ¿åé»‘å®¢</span>
            </span>
        <span class="battery">ğŸ”‹ 84%</span>
    </div>

    <div id="chatHistory" class="chat-history">
        <div class="msg system">
            <span class="lang-en-only">Establishing secure connection...</span>
            <span class="lang-cn-only">æ­£åœ¨å»ºç«‹åŠ å¯†è¿æ¥...</span>
        </div>
    </div>

    <div class="phone-controls">
        <div id="inventoryBar" class="inventory-bar">
            <span class="inv-label">
                <span class="lang-en-only">KEYCHAIN:</span>
                <span class="lang-cn-only">å¯†é’¥åº“:</span>
            </span>
            <div id="inventoryList"></div>
        </div>

        <div id="actionArea" class="action-grid">
            <button class="btn-opt" disabled>
                <span class="lang-en-only">Synchronizing...</span>
                <span class="lang-cn-only">æ­£åœ¨åŒæ­¥æ•°æ®...</span>
            </button>
        </div>
    </div>
</div>

<div id="deathScreen" class="death-screen hidden">
    <!-- ç»“å±€èƒŒæ™¯å›¾ç‰‡ -->
    <div class="death-bg-image"></div>
    <div class="death-bg-overlay"></div>
    
    <!-- ç»“å±€æ ‡é¢˜ -->
    <div class="death-title">
        <span class="lang-cn-only">Bad End : å¼€é™¤ç»“å±€</span>
        <span class="lang-en-only">Bad End : Expelled</span>
    </div>
    
    <div class="death-console">
        <div id="deathTextContainer"></div>
        <div id="deathCursor" class="blinking-cursor">_</div>
    </div>

    <!-- è·³è¿‡æŒ‰é’® -->
    <button id="skipButton" class="btn-skip hidden">
        <span class="lang-en-only">SKIP â–¶â–¶</span>
        <span class="lang-cn-only">è·³è¿‡ â–¶â–¶</span>
    </button>

    <div id="deathControls" class="death-controls hidden">
        <div id="retryPrompt" class="retry-prompt"></div>

        <button id="retryButton" class="btn-retry glitch-hover" onclick="location.reload()">
        </button>
    </div>
</div>
<!-- ============================================================ -->
<!-- è„šæœ¬åŠ è½½é¡ºåºå¾ˆé‡è¦ï¼ -->
<!-- ============================================================ -->

<!-- 1. å·¥å…·åº“ (å¦‚æœéœ€è¦åŠ å¯†åŠŸèƒ½) -->
<script src="../tools/decrypt-lib.js"></script>
<script src="../tools/config-loader.js"></script>

<!-- 2. å­˜æ¡£ç®¡ç†å™¨ (å¿…é¡»åœ¨å¼•æ“ä¹‹å‰åŠ è½½) -->
<script src="save-manager.js"></script>

<script src="minigame-manager.js"></script>
<!-- 3. æ¸¸æˆå¼•æ“ (æœ€ååŠ è½½ï¼Œç¡®ä¿é…ç½®å·²å°±ç»ª) -->
<script src="hacker-engine.js"></script>

<script>
    // ============================================================
    // é…ç½®åŠ è½½ä¸è¯­è¨€åˆ‡æ¢
    // ============================================================

    // é…ç½®é‡è½½å‡½æ•°
    async function reloadAllConfigs(lang) {
        try {
            // åŠ è½½å…³å¡é…ç½®
            await UnifiedLoader.load(
                'level1-config',
                'LevelConfig',
                'ENCRYPTED_LEVEL_CONFIG',
                lang
            );

            // åŠ è½½ Hacker æ–‡æœ¬é…ç½®
            await UnifiedLoader.load(
                'hacker-config',
                'HackerConfig',
                'ENCRYPTED_HACKER_CONFIG',
                lang
            );

            console.log(`[Lang] Configs loaded for [${lang}]`);
        } catch(e) {
            console.error("Config load failed:", e);
        }
    }

    // è¯­è¨€åˆå§‹åŒ–
    async function initLanguage() {
        const lang = localStorage.getItem('app_lang') || 'cn';
        await setLanguage(lang, true); // true = é¦–æ¬¡åŠ è½½
    }

    // è¯­è¨€åˆ‡æ¢
    function toggleLanguage() {
        const currentLang = document.body.classList.contains('lang-en') ? 'cn' : 'en';
        setLanguage(currentLang, false);
    }

    // è®¾ç½®è¯­è¨€
    async function setLanguage(lang, isInit = false) {
        // 1. è®¾ç½® Body ç±» (æ§åˆ¶ HTML ä¸­çš„ lang-cn-only / lang-en-only)
        document.body.classList.remove('lang-cn', 'lang-en');
        document.body.classList.add('lang-' + lang);

        // 2. å­˜å…¥æœ¬åœ°å­˜å‚¨
        localStorage.setItem('app_lang', lang);

        // 3. æ›´æ–°æŒ‰é’®é«˜äº®çŠ¶æ€
        document.getElementById('btn-cn').classList.toggle('active', lang === 'cn');
        document.getElementById('btn-en').classList.toggle('active', lang === 'en');

        // 4. é‡è½½é…ç½®æ–‡ä»¶
        await reloadAllConfigs(lang);

        // 5. é€šçŸ¥æ¸¸æˆå¼•æ“åˆ·æ–° UI
        if (window.gameEngine && !isInit) {
            window.gameEngine.refreshUiText(lang);
        }
    }

    // ============================================================
    // å¯åŠ¨æµç¨‹
    // ============================================================
    (async function() {
        try {
            // 1. å…ˆç­‰å¾…é…ç½®å’Œè¯­è¨€åŠ è½½å®Œæˆ
            await initLanguage();
            console.log("Config loaded, starting engine...");

            // 2. é…ç½®å°±ç»ªåï¼Œæ‰‹åŠ¨å¯åŠ¨å¼•æ“
            // æ­¤æ—¶ hacker-engine.js å·²ç»åŠ è½½(å› ä¸ºå®ƒåœ¨bodyåº•éƒ¨)ï¼ŒGameEngine ç±»å·²å¯ç”¨
            if (typeof GameEngine !== 'undefined') {
                new GameEngine();
            } else {
                console.error("GameEngine class not found!");
            }
        } catch (e) {
            console.error("Critical Error during startup:", e);
        }
    })();
</script>

<div id="finalLockScreen" class="lock-screen hidden">
    <div class="lock-container">
        <div class="lock-header">
            <span class="lang-en-only">âš  CONNECTION TERMINATED BY HOST âš </span>
            <span class="lang-cn-only">âš  è¿œç¨‹ä¸»æœºå¼ºåˆ¶æ–­å¼€è¿æ¥ âš </span>
        </div>
        <div class="lock-body">
            <div class="lock-status">
                <span>
                    <span class="lang-en-only">PROTOCOL:</span>
                    <span class="lang-cn-only">æ‰§è¡Œåè®®:</span>
                </span>
                <span style="color:#ef4444">SILENT_NIGHT (é™é»˜)</span><br>

                <span>
                    <span class="lang-en-only">STATUS:</span>
                    <span class="lang-cn-only">å½“å‰çŠ¶æ€:</span>
                </span>
                <span style="color:#ef4444">
                    <span class="lang-en-only">LOCKED</span>
                    <span class="lang-cn-only">å·²é”å®š</span>
                </span><br>

                <span>
                    <span class="lang-en-only">ENCRYPTION:</span>
                    <span class="lang-cn-only">åŠ å¯†å±‚çº§:</span>
                </span>
                <span>AES-4096 (Running...)</span>
            </div>

            <div class="lock-timer-box">
                <div class="lock-label">
                    <span class="lang-en-only">NEXT SAFE WINDOW</span>
                    <span class="lang-cn-only">ä¸‹ä¸€æ¬¡å®‰å…¨è¿æ¥çª—å£</span>
                </div>
                <div class="lock-date">2025 . 12 . 12</div>
                <div class="lock-sub">
                    <span class="lang-en-only">WAITING FOR HANDSHAKE...</span>
                    <span class="lang-cn-only">ç­‰å¾…æ¡æ‰‹ä¿¡å·...</span>
                </div>
            </div>

            <div class="lock-console">
                > Upload complete: ANOMALY_CORE.dat (100%)<br>
                > Verifying hash... OK.<br>
                > <span class="lang-en-only">Remote user [Z.Chen] initiated disconnect.</span><span class="lang-cn-only">è¿œç¨‹ç”¨æˆ· [å¼ æ™¨] å‘èµ·æ–­å¼€è¯·æ±‚.</span><br>
                > <span class="lang-en-only">Closing ports... CLOSED.</span><span class="lang-cn-only">æ­£åœ¨å…³é—­ç«¯å£... å·²å…³é—­.</span><br>
                > System going to standby.<br>
                <span class="blinking-cursor">_</span>
            </div>
        </div>
    </div>
</div>
<!-- è·³è¿‡æ¸¸æˆç¡®è®¤å¼¹çª— -->
<div id="skipConfirmModal" class="skip-confirm-overlay hidden">
    <div class="skip-confirm-box">
        <div class="skip-confirm-icon">âš ï¸</div>
        <h3 class="skip-confirm-title">
            <span class="lang-cn-only">ç¡®è®¤è·³è¿‡ï¼Ÿ</span>
            <span class="lang-en-only">Skip this level?</span>
        </h3>
        <p class="skip-confirm-msg">
            <span class="lang-cn-only">è·³è¿‡åå°†ç›´æ¥è¿›å…¥ä¸‹ä¸€é˜¶æ®µçš„å‰§æƒ…ã€‚<br>ä½ å°†é”™è¿‡æœ¬å…³çš„æ½œå…¥ä½“éªŒã€‚</span>
            <span class="lang-en-only">You will skip directly to the next story phase.<br>You will miss the infiltration gameplay of this level.</span>
        </p>
        <div class="skip-confirm-buttons">
            <button class="btn-confirm-cancel" onclick="window.gameEngine?.hideSkipConfirm()">
                <span class="lang-cn-only">ç»§ç»­æ¸¸æˆ</span>
                <span class="lang-en-only">Continue Playing</span>
            </button>
            <button class="btn-confirm-skip" onclick="window.gameEngine?.confirmSkipToMiniGame()">
                <span class="lang-cn-only">ç¡®è®¤è·³è¿‡</span>
                <span class="lang-en-only">Confirm Skip</span>
            </button>
        </div>
    </div>
</div>

</body>
</html>