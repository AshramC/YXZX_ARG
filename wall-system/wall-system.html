<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ ¡å›­å¢™ - å¼‚è±¡ä¸­å­¦å­¦ç”Ÿæ ¡å›­å¢™</title>
  <link rel="stylesheet" href="wall-style.css">
</head>
<body>

<nav class="navbar">
  <div class="brand-logo">
    <span style="font-size: 1.5rem;">ğŸ”¥</span>
    <span class="lang-cn-only">æ ¡å›­å¢™ Campus Wall</span>
    <span class="lang-en-only">Campus Wall</span>
    <span id="termInfo" style="font-size: 0.8rem; color: var(--text-muted); font-weight: 400; margin-left: 10px;"></span>
  </div>

  <div style="display: flex; align-items: center;">

    <div class="lang-switch-wrapper">
      <select class="lang-selector">
        <option value="cn">CN</option>
        <option value="en">EN</option>
      </select>
    </div>

    <button id="loginBtn" class="btn btn-ghost" style="font-size: 0.8rem;">
      <span class="lang-cn-only">ç®¡ç†å‘˜ç™»å½•</span>
      <span class="lang-en-only">Admin Login</span>
    </button>

    <div id="adminStatus" style="display: none; align-items: center; gap: 10px;">
      <span class="admin-badge">ADMIN MODE</span>
      <button id="logoutBtn" class="btn btn-ghost" style="color: var(--danger);">
        <span class="lang-cn-only">é€€å‡º</span>
        <span class="lang-en-only">Logout</span>
      </button>
    </div>
  </div>
</nav>

<div class="layout-container">

  <aside class="left-col">
    <div class="nav-menu">
      <div id="navHome" class="nav-item active">
        <span>ğŸ </span>
        <span class="lang-cn-only">å…¨éƒ¨åŠ¨æ€</span>
        <span class="lang-en-only">All Posts</span>
      </div>
      <div id="navDeleted" class="nav-item" style="display: none; color: var(--danger);">
        <span>ğŸ—‘ï¸</span>
        <span class="lang-cn-only">å·²åˆ é™¤è®°å½•</span>
        <span class="lang-en-only">Deleted Logs</span>
      </div>

      <div style="margin-top: 1.5rem; padding-left: 1rem; font-size: 0.8rem; color: var(--text-muted); font-weight: 700; margin-bottom: 0.5rem;">
        <span class="lang-cn-only">æ¨èè¯é¢˜</span>
        <span class="lang-en-only">Trending</span>
      </div>
      <div id="chips" style="padding: 0 0.5rem;"></div>
    </div>
  </aside>

  <main class="feed-col">
    <div class="search-bar-card">
      <input id="q" class="search-input i18n-attr"
             data-attr="placeholder"
             data-cn="æœç´¢å†…å®¹..."
             data-en="Search content..."
             placeholder="æœç´¢å†…å®¹...">
      <button id="doSearch" class="btn btn-primary">
        <span class="lang-cn-only">æœç´¢</span>
        <span class="lang-en-only">Search</span>
      </button>
    </div>

    <div id="pinned"></div>

    <div id="feed"></div>
  </main>

  <aside class="right-col" id="rightPanel">
    <div class="detail-panel">
      <div id="detailContent">
        <div class="detail-placeholder">
          <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ‘ˆ</div>
          <p>
            <span class="lang-cn-only">ç‚¹å‡»å·¦ä¾§å¸–å­æŸ¥çœ‹è¯¦æƒ…</span>
            <span class="lang-en-only">Select a post to view details</span>
          </p>
        </div>
      </div>
      <button class="btn btn-ghost" onclick="closeDetail()" style="margin-top: 1rem; width: 100%; display: none;" id="closeDetailBtn">
        <span class="lang-cn-only">è¿”å›åˆ—è¡¨</span>
        <span class="lang-en-only">Back</span>
      </button>
    </div>
  </aside>

</div>

<div id="loginModal" class="modal">
  <div class="modal-box">
    <h3 style="margin-bottom: 1rem;">
      <span class="lang-cn-only">ç®¡ç†å‘˜éªŒè¯</span>
      <span class="lang-en-only">Admin Verification</span>
    </h3>
    <input id="adminUser" class="search-input i18n-attr" style="width: 100%; margin-bottom: 10px;"
           data-attr="placeholder" data-cn="ç”¨æˆ·å" data-en="Username" placeholder="ç”¨æˆ·å">
    <input id="adminPass" class="search-input i18n-attr" style="width: 100%; margin-bottom: 1rem;"
           data-attr="placeholder" data-cn="å¯†ç " data-en="Password"
           placeholder="å¯†ç " type="password">
    <div id="loginError" style="color: var(--danger); font-size: 0.85rem; margin-bottom: 1rem; display: none;">
      <span class="lang-cn-only">éªŒè¯å¤±è´¥</span>
      <span class="lang-en-only">Failed</span>
    </div>
    <div style="display: flex; justify-content: flex-end; gap: 10px;">
      <button id="cancelLogin" class="btn btn-ghost">
        <span class="lang-cn-only">å–æ¶ˆ</span>
        <span class="lang-en-only">Cancel</span>
      </button>
      <button id="confirmLogin" class="btn btn-primary">
        <span class="lang-cn-only">ç¡®è®¤ç™»å½•</span>
        <span class="lang-en-only">Confirm</span>
      </button>
    </div>
  </div>
</div>

<script src="../tools/decrypt-lib.js"></script>
<script src="../tools/lang-switch.js"></script>
<script src="../tools/config-loader.js"></script>
<script src="wall-app.js"></script>

<script>
  // ========== 1. æ ¸å¿ƒçŠ¶æ€ç®¡ç† ==========

  const STORAGE_SPECIAL_MODE = 'WALL_SPECIAL_MODE';

  /**
   * æ£€æŸ¥æ˜¯å¦è¿›å…¥ç‰¹æ®Šæ¨¡å¼
   * é€»è¾‘ï¼šURLå‚æ•° ?reveal=true å¼ºåˆ¶å¼€å¯ï¼Œå¦åˆ™è¯»å– LocalStorage
   * (å¼€å¯åæ²¡æœ‰ UI æç¤ºï¼Œå®Œå…¨éšè”½)
   */
  function checkSpecialMode() {
    const urlParams = new URLSearchParams(window.location.search);

    // å¦‚æœ URL åŒ…å«å‚æ•°ï¼Œå¼ºåˆ¶æ¿€æ´»å¹¶æŒä¹…åŒ–
    if (urlParams.get('reveal') === 'true') {
      localStorage.setItem(STORAGE_SPECIAL_MODE, 'true');
      // æ¸…é™¤ URL å‚æ•°ï¼Œä¿æŒåœ°å€æ æ•´æ´
      window.history.replaceState({}, document.title, window.location.pathname);
      return true;
    }

    // å¦åˆ™è¯»å–æœ¬åœ°å­˜å‚¨
    return localStorage.getItem(STORAGE_SPECIAL_MODE) === 'true';
  }

  window.addEventListener('storage', (event) => {
      // ç›‘å¬ç‰¹æ®Šæ¨¡å¼ Key çš„å˜åŒ–
      if (event.key === 'WALL_SPECIAL_MODE') {
          // æ— è®ºå½“å‰çª—å£æ˜¯æ˜¾ç¤ºè¿˜æ˜¯éšè—ï¼Œåªè¦ Key å˜äº†ï¼Œç«‹å³è‡ªæˆ‘åˆ·æ–°
          if (!event.newValue || event.newValue === 'false') {
              window.location.reload();
          }
      }
  });

  // ========== 2. é…ç½®åŠ è½½é€»è¾‘ ==========

  /**
   * åŠ è½½é…ç½®å¹¶åˆå§‹åŒ–åº”ç”¨
   * æ­¤å‡½æ•°ç”± lang-switch.js è°ƒç”¨ï¼Œæˆ–åœ¨é¡µé¢åˆå§‹åŒ–æ—¶è°ƒç”¨
   */
  window.reloadConfig = async function(lang) {
    try {
      const isSpecial = checkSpecialMode();

      // åŠ¨æ€å†³å®šæ–‡ä»¶åï¼Œä½† UI å±‚é¢æ— æ„ŸçŸ¥
      const configBaseName = isSpecial ? 'wall-special-config' : 'wall-config';

      console.log(`[System] Loading Content: ${isSpecial ? 'Override' : 'Default'} (${lang})`);

      // æ ¸å¿ƒåŠ è½½ï¼šç»Ÿä¸€è¯»å– WALL_CONFIG
      await UnifiedLoader.load(
              configBaseName,          // æ–‡ä»¶åä¸åŒ
              'WALL_CONFIG',           // å˜é‡åç›¸åŒ
              'ENCRYPTED_WALL_CONFIG', // åŠ å¯†å˜é‡åç›¸åŒ
              lang
      );

      // é…ç½®åŠ è½½å®Œæ¯•ï¼Œå¯åŠ¨åº”ç”¨é€»è¾‘
      if (typeof initializeWallApp === 'function') {
        initializeWallApp();
      }

    } catch(e) {
      console.error("Wall Config Load Failed", e);
    }
  };

  // ========== 3. ç«‹å³å¯åŠ¨ ==========
  (async function() {
    const currentLang = localStorage.getItem('app_lang') || 'cn';
    await window.reloadConfig(currentLang);
  })();
</script>
</body>
</html>