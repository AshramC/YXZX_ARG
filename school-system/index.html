<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½• - å¼‚è±¡ä¸­å­¦å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="login-wrapper">
    <div class="login-brand">
        <h1 class="brand-title" style="font-size: 2.5rem; line-height: 1.3;">
            <span class="lang-cn-only">å¼‚è±¡ä¸­å­¦<br>å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</span>
            <span class="lang-en-only">Anomaly High<br>Student Info System</span>
        </h1>
        <p class="brand-desc" style="font-size: 0.95rem; line-height: 1.6; margin-top: 1.5rem;">
            <span class="lang-cn-only" style="display: block; margin: 0.5rem 0;"> å­¦ç±æ¡£æ¡ˆ | æˆç»©æŸ¥è¯¢ | å¥–æƒ©è®°å½•</span>
            <span class="lang-en-only" style="display: block; margin: 0.5rem 0;"> Records | Grades | Disciplinary</span>

            <span class="lang-cn-only" style="display: block; margin: 0.5rem 0;"> ç»Ÿä¸€èº«ä»½è®¤è¯ | åˆ†çº§æƒé™ç®¡ç†</span>
            <span class="lang-en-only" style="display: block; margin: 0.5rem 0;"> Unified Auth | Access Control</span>

            <span style="display: block; margin: 1rem 0 0.5rem; font-size: 0.85rem; opacity: 0.7;">
              <span class="lang-cn-only">ç³»ç»Ÿç»´æŠ¤ï¼šæ•™åŠ¡å¤„</span>
              <span class="lang-en-only">Maint: Academic Affairs</span>
            </span>
        </p>
    </div>

    <div class="login-form-container" style="position: relative;">

        <div class="lang-switch-wrapper">
            <select class="lang-selector">
                <option value="cn">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                <option value="en">ğŸ‡ºğŸ‡¸ English</option>
            </select>
        </div>

        <div style="width: 100%; max-width: 360px;">
            <h2 style="margin-bottom: 2rem; font-size: 1.8rem;">
                <span class="lang-cn-only">æ¬¢è¿å›æ¥</span>
                <span class="lang-en-only">Welcome Back</span>
            </h2>
            <form id="loginForm">
                <div class="input-group">
                    <input type="text" id="username" class="input-field" placeholder=" " autocomplete="off" required>
                    <label for="username" class="input-label">
                        <span class="lang-cn-only">æ•™åŠ¡è´¦å·</span>
                        <span class="lang-en-only">Username</span>
                    </label>
                </div>

                <div class="input-group">
                    <div style="position: relative; width: 100%;">
                        <input type="password" id="password" class="input-field" placeholder=" " style="padding-right: 3rem;" required>
                        <label for="password" class="input-label">
                            <span class="lang-cn-only">å¯†ç </span>
                            <span class="lang-en-only">Password</span>
                        </label>
                        <button type="button" id="togglePassword" style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 0.25rem; display: flex; align-items: center; justify-content: center; transition: color 0.2s; z-index: 10;">
                            <svg id="eyeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn" style="width: 100%; justify-content: center;">
                    <span class="lang-cn-only">ç™» å½• ç³»ç»Ÿ</span>
                    <span class="lang-en-only">Login System</span>
                </button>
            </form>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script src="../tools/decrypt-lib.js"></script>
<script src="../tools/lang-switch.js"></script>
<script src="../tools/config-loader.js"></script>

<script>
    // 1. åŠ¨æ€åŠ è½½è„šæœ¬è¾…åŠ©å‡½æ•°
    function loadScript(src) {
        return new Promise((resolve, reject) => {
            document.querySelectorAll(`script[src*="school-config"]`).forEach(s => s.remove());
            const script = document.createElement('script');
            script.src = src + '?t=' + Date.now();
            script.onload = () => resolve();
            script.onerror = () => reject(new Error(`Failed to load ${src}`));
            document.body.appendChild(script);
        });
    }

    // 2. æ ¸å¿ƒï¼šé‡è½½é…ç½®
    window.reloadConfig = async function(lang) {
        try {
            await UnifiedLoader.load(
                'school-config',
                'SchoolSystemConfig',
                'ENCRYPTED_SCHOOL_CONFIG',
                lang
            );
        } catch(e) {
            console.error("School Config Failed", e);
        }
    };

    // ============================================================
    // ã€ä¿®å¤ 1ã€‘ç«‹å³ç»‘å®šäº‹ä»¶ï¼Œç§»é™¤ async ä¾èµ–
    // ============================================================
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault(); // æ ¸å¿ƒï¼šç«‹å³é˜»æ­¢é»˜è®¤åˆ·æ–°

            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value;
            const isEn = localStorage.getItem('app_lang') === 'en';

            // é˜²å¾¡æ€§æ£€æŸ¥
            if (!window.SchoolSystemConfig || !window.SchoolSystemConfig.accounts) {
                // å¦‚æœé…ç½®è¿˜æ²¡åŠ è½½å¥½ï¼Œæ‰‹åŠ¨è§¦å‘ toast æç¤º
                const toast = document.getElementById('toast');
                toast.textContent = isEn ? "System initializing..." : "ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–...";
                toast.className = 'toast show';
                setTimeout(() => toast.classList.remove('show'), 3000);
                return;
            }

            const account = SchoolSystemConfig.accounts.find(acc => acc.id === user && acc.password === pass);

            if(account) {
                sessionStorage.setItem('schoolSystem_user', account.id);
                sessionStorage.setItem('schoolSystem_type', account.accountType);
                window.location.href = 'dashboard.html';
            } else {
                // å¤ç”¨ showToast é€»è¾‘ä¸å¤ªæ–¹ä¾¿ï¼ˆå› ä¸ºå®ƒåœ¨é—­åŒ…é‡Œï¼‰ï¼Œè¿™é‡Œç›´æ¥æ“ä½œ DOM æˆ–è€…æŠŠ showToast æå‡ºæ¥
                // ä¸ºç®€å•èµ·è§ï¼Œè¿™é‡Œç®€å•å¤ç° toast é€»è¾‘
                const toast = document.getElementById('toast');
                toast.textContent = isEn ? 'Invalid username or password' : 'è´¦å·æˆ–å¯†ç ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•';
                toast.className = 'toast show error';
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
        });
    }

    (async function() {
        // ã€ä¿®å¤ 2ã€‘é˜²æ­¢ç«æ€ï¼šå¦‚æœ lang-switch å·²ç»åŠ è½½äº†é…ç½®ï¼Œè¿™é‡Œè·³è¿‡
        if (!window.SchoolSystemConfig) {
            const currentLang = localStorage.getItem('app_lang') || 'cn';
            await window.reloadConfig(currentLang);
        }

        // å¯†ç åˆ‡æ¢é€»è¾‘ (UI é€»è¾‘æ”¾åœ¨è¿™é‡Œæ²¡é—®é¢˜)
        const passwordInput = document.getElementById('password');
        const toggleBtn = document.getElementById('togglePassword');
        const eyeIcon = document.getElementById('eyeIcon');

        if (toggleBtn) {
            toggleBtn.addEventListener('click', function() {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeIcon.innerHTML = `<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>`;
                    toggleBtn.style.color = '#3b82f6';
                } else {
                    passwordInput.type = 'password';
                    eyeIcon.innerHTML = `<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>`;
                    toggleBtn.style.color = 'var(--text-muted)';
                }
            });
        }
    })();
</script>
</body>
</html>