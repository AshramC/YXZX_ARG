<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç±æ¡£æ¡ˆ - ä»ªè¡¨ç›˜</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .search-input:disabled {
            background-color: #f8fafc;
            color: #64748b;
            cursor: not-allowed;
            border-color: #e2e8f0;
        }
        .permission-alert {
            display: none;
            margin-top: 16px;
            font-size: 14px;
            color: #ef4444;
            background: #fef2f2;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #fee2e2;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-logo">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
            <path d="M6 12v5c3 3 9 3 12 0v-5"/>
        </svg>
        EduData
    </div>
    <div class="nav-profile">
        <select class="lang-selector" style="margin-right: 1rem; padding: 0.2rem 0.5rem; font-size: 0.8rem;">
            <option value="cn">CN</option>
            <option value="en">EN</option>
        </select>

        <span id="userRoleBadge" style="font-size: 12px; padding: 4px 8px; background: #e0e7ff; color: var(--primary); border-radius: 4px; font-weight:600">Student</span>
        <div class="avatar" id="userAvatar">U</div>
        <button id="logoutBtn" class="btn btn-ghost" style="padding: 8px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        </button>
    </div>
</nav>

<main class="container">
    <section class="hero-search" id="searchSection">
        <h1 style="font-size: 2rem; font-weight: 800; margin-bottom: 1rem;">
            <span class="lang-cn-only">æ¡£æ¡ˆæ£€ç´¢</span>
            <span class="lang-en-only">Record Search</span>
        </h1>
        <p id="searchSubtitle" style="color: var(--text-muted); margin-bottom: 2rem;">
            <span class="lang-cn-only">è¾“å…¥å§“åæˆ–å­¦å·å¿«é€ŸæŸ¥æ‰¾å­¦ç”Ÿæ¡£æ¡ˆä¿¡æ¯</span>
            <span class="lang-en-only">Enter name or ID to search student records</span>
        </p>

        <form id="searchForm" class="search-box-wrapper">
            <input type="text" class="search-input i18n-attr" id="searchInput"
                   data-attr="placeholder"
                   data-cn="è¯·è¾“å…¥æœç´¢å…³é”®è¯..."
                   data-en="Enter keywords..."
                   placeholder="è¯·è¾“å…¥æœç´¢å…³é”®è¯..." autocomplete="off">
            <button type="submit" id="searchSubmitBtn" class="search-btn-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </button>
        </form>

        <div id="permissionHint" class="permission-alert">
            <div style="margin-bottom: 4px;">
                <span class="lang-cn-only">ğŸ”’ <strong>æ— æœç´¢æƒé™</strong>ï¼šå½“å‰è´¦å·ä»…æ˜¾ç¤ºæœ¬äººä¿¡æ¯ï¼Œæœç´¢ä»–äººå­¦ç±ä¿¡æ¯è¯·ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ã€‚</span>
                <span class="lang-en-only">ğŸ”’ <strong>No Permission</strong>: You can only view your own record. Use Admin account to search others.</span>
            </div>
            <div style="font-size: 10px; opacity: 0.9; padding-top: 4px; border-top: 1px dashed rgba(239, 68, 68, 0.3);">
                <span class="lang-cn-only">ğŸ’¡ æç¤ºï¼šå¦‚æœä¸æ¸…æ¥šè¯¥å»å“ªè·å–ç®¡ç†å‘˜è´¦æˆ·ï¼Œä¸å¦¨å» <strong>æ ¡å›­å¢™</strong> æœç´¢ä¸€ä¸‹â€œç®¡ç†å‘˜è´¦å·â€ã€‚</span>
                <span class="lang-en-only">ğŸ’¡ Hint: Try searching the <strong>Campus Wall</strong> for Admin credentials.</span>
            </div>
        </div>
    </section>

    <section id="resultCard" class="card" style="display: none; opacity: 0; transform: translateY(20px);">
        <div style="padding: 2.5rem;">
            <div class="student-profile-header">
                <div class="profile-avatar-large" id="resAvatar"></div>
                <div>
                    <h2 id="resName" style="font-size: 1.8rem; margin-bottom: 0.25rem;">--</h2>
                    <p id="resId" style="color: var(--text-muted); font-family: monospace;">ID: --</p>
                </div>
            </div>

            <div class="grid-info">
                <div class="info-cell">
                    <div class="label"><span class="lang-cn-only">æ€§åˆ«</span><span class="lang-en-only">Gender</span></div>
                    <div class="value" id="resGender">--</div>
                </div>
                <div class="info-cell">
                    <div class="label"><span class="lang-cn-only">å‡ºç”Ÿæ—¥æœŸ</span><span class="lang-en-only">Birth Date</span></div>
                    <div class="value" id="resBirth">--</div>
                </div>
                <div class="info-cell">
                    <div class="label"><span class="lang-cn-only">æ‰€åœ¨å¹´çº§</span><span class="lang-en-only">Grade</span></div>
                    <div class="value" id="resGrade">--</div>
                </div>
                <div class="info-cell">
                    <div class="label"><span class="lang-cn-only">ç­çº§</span><span class="lang-en-only">Class</span></div>
                    <div class="value" id="resClass">--</div>
                </div>
                <div class="info-cell">
                    <div class="label"><span class="lang-cn-only">å…¥å­¦æ—¥æœŸ</span><span class="lang-en-only">Enroll Date</span></div>
                    <div class="value" id="resDate">--</div>
                </div>
                <div class="info-cell" style="grid-column: span 2;">
                    <div class="label"><span class="lang-cn-only">å®¶åº­ä½å€</span><span class="lang-en-only">Address</span></div>
                    <div class="value" id="resAddress">--</div>
                </div>
                <div class="info-cell" id="resRemarkBox" style="grid-column: span 2; display: none; background-color: #fff7ed;">
                    <div class="label" style="color: #ea580c;">
                        <span class="lang-cn-only">ç®¡ç†å‘˜å¤‡æ³¨</span><span class="lang-en-only">Admin Remark</span>
                    </div>
                    <div class="value" id="resRemark" style="color: #c2410c;">--</div>
                </div>
            </div>
        </div>
    </section>

    <div id="messageBox" style="text-align: center; margin-top: 2rem; color: var(--text-muted); display: none;">
        <p id="messageText">
            <span class="lang-cn-only">æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯</span>
            <span class="lang-en-only">No record found</span>
        </p>
    </div>
</main>

<div id="toast" class="toast"></div>

<script src="../tools/decrypt-lib.js"></script>
<script src="../tools/lang-switch.js"></script>
<script src="../tools/config-loader.js"></script>

<script>
    // ============================================================
    // 1. åŸºç¡€å·¥å…·å‡½æ•°
    // ============================================================

    // åŠ¨æ€åŠ è½½ Config è„šæœ¬
    function loadScript(src) {
        return new Promise((resolve, reject) => {
            // ç§»é™¤æ—§çš„ config è„šæœ¬ï¼Œé˜²æ­¢å…¨å±€å˜é‡æ±¡æŸ“æˆ–ç¼“å­˜
            document.querySelectorAll(`script[src*="school-config"]`).forEach(s => s.remove());

            const script = document.createElement('script');
            script.src = src + '?t=' + Date.now(); // æ·»åŠ æ—¶é—´æˆ³é˜²ç¼“å­˜
            script.onload = () => resolve();
            script.onerror = () => reject(new Error(`Failed to load ${src}`));
            document.body.appendChild(script);
        });
    }

    // æ ¸å¿ƒï¼šé‡è½½é…ç½®å¹¶åˆ·æ–°è§†å›¾ (ç”± lang-switch.js è°ƒç”¨)
    window.reloadConfig = async function(lang) {
        try {
            await UnifiedLoader.load(
                'school-config',
                'SchoolSystemConfig',
                'ENCRYPTED_SCHOOL_CONFIG',
                lang
            );
            initApp();
        } catch(e) {
            console.error("School Config Failed", e);
        }
    };

    // ============================================================
    // 2. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
    // ============================================================

    async function initApp() {
        // é˜²å¾¡æ€§æ£€æŸ¥
        if (!window.SchoolSystemConfig) return;

        const userId = sessionStorage.getItem('schoolSystem_user');
        const type = sessionStorage.getItem('schoolSystem_type'); // 'student' æˆ– 'admin'
        const isEn = localStorage.getItem('app_lang') === 'en'; // å½“å‰æ˜¯å¦ä¸ºè‹±æ–‡æ¨¡å¼

        // æœªç™»å½•æ‹¦æˆª
        if(!userId) { window.location.href = 'index.html'; return; }

        // è·å–å½“å‰è´¦æˆ·ä¿¡æ¯ (é…ç½®å·²åˆ†ç¦»ï¼ŒdisplayName ç›´æ¥æ˜¯å­—ç¬¦ä¸²)
        const currentAccount = SchoolSystemConfig.accounts.find(acc => acc.id === userId);
        const displayName = currentAccount ? currentAccount.displayName : userId;

        // æ›´æ–° Navbar ç”¨æˆ·ä¿¡æ¯
        document.getElementById('userAvatar').textContent = displayName[0].toUpperCase();
        const roleBadge = document.getElementById('userRoleBadge');
        roleBadge.textContent = type === 'admin' ? 'ADMIN' : 'STUDENT';

        // ç®¡ç†å‘˜å¾½ç« æ ·å¼åŒºåˆ†
        if(type === 'admin') {
            roleBadge.style.background = '#fee2e2';
            roleBadge.style.color = '#ef4444';
        } else {
            roleBadge.style.background = '#e0e7ff';
            roleBadge.style.color = 'var(--primary)';
        }

        // -------------------------------------------------
        // æ¸²æŸ“å‡½æ•°ï¼šå°†å­¦ç”Ÿæ•°æ®å¡«å……åˆ°å¡ç‰‡
        // -------------------------------------------------
        function renderResult(data) {
            const card = document.getElementById('resultCard');

            // å¤´åƒå–åå­—é¦–å­—æ¯
            const initial = data.name ? data.name.charAt(0).toUpperCase() : '?';
            document.getElementById('resAvatar').textContent = initial;

            // å¡«å……åŸºæœ¬ä¿¡æ¯ (æ•°æ®æºå·²æ˜¯å•è¯­è¨€å­—ç¬¦ä¸²ï¼Œç›´æ¥èµ‹å€¼)
            document.getElementById('resName').textContent = data.name;
            document.getElementById('resId').textContent = data.studentId;
            document.getElementById('resGender').textContent = data.gender;
            document.getElementById('resBirth').textContent = data.birthDate;
            document.getElementById('resGrade').textContent = data.grade;
            document.getElementById('resClass').textContent = data.class;
            document.getElementById('resDate').textContent = data.enrollmentDate;
            document.getElementById('resAddress').textContent = data.homeAddress;

            // å¤‡æ³¨ä¿¡æ¯ (ä»…ç®¡ç†å‘˜å¯è§)
            const remarkBox = document.getElementById('resRemarkBox');
            if(type === 'admin') {
                remarkBox.style.display = 'block';
                // å¦‚æœå¤‡æ³¨ä¸ºç©ºï¼Œæ˜¾ç¤ºé»˜è®¤æ–‡æœ¬
                const defaultText = isEn ? 'None' : 'æ— ';
                document.getElementById('resRemark').textContent = data.remark || defaultText;
            } else {
                remarkBox.style.display = 'none';
            }

            // æ˜¾ç¤ºå¡ç‰‡åŠ¨ç”»
            card.style.display = 'block';
            void card.offsetWidth; // è§¦å‘é‡ç»˜
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';

            // éšè—"æœªæ‰¾åˆ°"æç¤º
            document.getElementById('messageBox').style.display = 'none';
        }

        // -------------------------------------------------
        // æƒé™æ§åˆ¶ä¸ç•Œé¢çŠ¶æ€åˆå§‹åŒ–
        // -------------------------------------------------
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchSubmitBtn');
        const subTitle = document.getElementById('searchSubtitle');
        const hint = document.getElementById('permissionHint');

        if (type === 'student') {
            // === å­¦ç”Ÿæ¨¡å¼ ===

            // 1. é”å®šè¾“å…¥æ¡†
            searchInput.disabled = true;
            searchInput.value = "";
            searchInput.placeholder = isEn ? "Locked: Viewing own record only" : "å·²é”å®šï¼šç³»ç»Ÿä»…æ˜¾ç¤ºæœ¬äººä¿¡æ¯";

            // 2. éšè—æœç´¢æŒ‰é’®
            searchBtn.style.display = 'none';

            // 3. æ›´æ–°å‰¯æ ‡é¢˜
            subTitle.innerHTML = isEn
                ? "Welcome back, here is your academic record"
                : "æ¬¢è¿å›æ¥ï¼Œä»¥ä¸‹æ˜¯æ‚¨çš„ä¸ªäººå­¦ç±æ¡£æ¡ˆ";

            // 4. æ˜¾ç¤ºæƒé™æç¤ºæ¡
            hint.style.display = "inline-block";

            // 5. è‡ªåŠ¨åŠ è½½æœ¬äººæ•°æ®
            const myId = currentAccount.studentId;
            const myData = SchoolSystemConfig.studentDatabase[myId];

            if (myData) {
                setTimeout(() => renderResult(myData), 100);
            } else {
                document.getElementById('messageBox').style.display = 'block';
                document.getElementById('messageText').textContent = isEn
                    ? 'Record not found, please contact admin.'
                    : 'ç³»ç»Ÿæ•°æ®ä¸­æœªæ‰¾åˆ°æ‚¨çš„æ¡£æ¡ˆï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚';
            }

        } else {
            // === ç®¡ç†å‘˜æ¨¡å¼ ===
            searchInput.disabled = false;
            searchInput.placeholder = isEn ? "Enter keywords..." : "è¯·è¾“å…¥æœç´¢å…³é”®è¯...";
            searchBtn.style.display = 'inline-block';
            hint.style.display = 'none';
            // è¿˜åŸå‰¯æ ‡é¢˜ (ä½¿ç”¨ HTML ä¸­å®šä¹‰çš„é»˜è®¤é™æ€åŒè¯­æ–‡æœ¬ï¼Œæˆ–æ­¤å¤„åŠ¨æ€è¦†ç›–å‡å¯ï¼Œæ­¤å¤„ä¿ç•™é™æ€é»˜è®¤)
        }

        // -------------------------------------------------
        // æ™ºèƒ½æœç´¢é€»è¾‘ (æ”¯æŒæ¨¡ç³ŠåŒ¹é…ã€å¿½ç•¥å¤§å°å†™)
        // -------------------------------------------------
        function checkMatch(student, term) {
            // 1. å¤„ç†æœç´¢è¯ï¼šè½¬å°å†™ï¼Œç§»é™¤æ‰€æœ‰ç©ºæ ¼
            // ä¾‹: "Wu Yu" -> "wuyu"
            const cleanTerm = term.toLowerCase().replace(/\s+/g, '');

            // 2. è·å–ç›®æ ‡æ•°æ® (é˜²æ­¢ undefined)
            const name = student.name || "";
            const id = student.studentId || "";

            // 3. å¤„ç†ç›®æ ‡åå­—
            const cleanName = name.toLowerCase().replace(/\s+/g, '');

            // 4. åŒ¹é…è§„åˆ™ï¼šIDåŒ…å« OR åå­—åŒ…å«
            return id.includes(cleanTerm) || cleanName.includes(cleanTerm);
        }

        // ç»‘å®šæœç´¢æäº¤äº‹ä»¶
        const form = document.getElementById('searchForm');
        // ç§»é™¤æ—§çš„ç›‘å¬å™¨ (é˜²æ­¢é‡è½½ config æ—¶é‡å¤ç»‘å®š)
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);

        // é‡æ–°è·å– DOM å¼•ç”¨
        const activeForm = document.getElementById('searchForm');
        const activeInput = document.getElementById('searchInput');

        activeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            // å¦‚æœè¾“å…¥æ¡†è¢«ç¦ç”¨ï¼ˆå¦‚å­¦ç”Ÿæ¨¡å¼ï¼‰ï¼Œåˆ™ä¸æ‰§è¡Œ
            if(activeInput.disabled) return;

            const rawTerm = activeInput.value.trim();
            if(!rawTerm) return;

            // ã€å…³é”®æ­¥éª¤ 1ã€‘æ ‡å‡†åŒ–æœç´¢è¯
            // é€»è¾‘ï¼šå…¨éƒ¨è½¬å°å†™ + ç§»é™¤æ‰€æœ‰ç©ºæ ¼
            // æ•ˆæœï¼šè¾“å…¥ "Zhang Chen" æˆ– "zhangchen" éƒ½ä¼šå˜ä¸º "zhangchen"
            const cleanTerm = rawTerm.toLowerCase().replace(/\s+/g, '');

            const card = document.getElementById('resultCard');
            // åŠ¨ç”»æ•ˆæœï¼šå…ˆéšè—å½“å‰å¡ç‰‡
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';

            setTimeout(() => {
                let foundData = null;

                // éå†æ•°æ®åº“æŸ¥æ‰¾
                for(let key in SchoolSystemConfig.studentDatabase) {
                    const s = SchoolSystemConfig.studentDatabase[key];

                    // ã€å…³é”®æ­¥éª¤ 2ã€‘æ ‡å‡†åŒ–æ•°æ®åº“ä¸­çš„åå­—
                    // æ•°æ®æºå·²æ˜¯å•è¯­è¨€å­—ç¬¦ä¸² (ä¾‹å¦‚ "Zhang Chen" æˆ– "å´å®‡")
                    const dbName = (s.name || "").toLowerCase().replace(/\s+/g, '');
                    const dbId = (s.studentId || ""); // å­¦å·ä¿æŒåŸæ ·ï¼ˆé€šå¸¸æ˜¯æ•°å­—ï¼‰

                    // ã€å…³é”®æ­¥éª¤ 3ã€‘ä¸¥æ ¼å…¨ç­‰åˆ¤æ–­ (===)
                    // é€»è¾‘ï¼šåªæœ‰å½“å¤„ç†åçš„å­—ç¬¦ä¸²å®Œå…¨ç›¸ç­‰æ—¶æ‰ç®—åŒ¹é…
                    // æ•ˆæœï¼š
                    // - æœ "Zhang" (zhang) !== "Zhang Chen" (zhangchen) -> ä¸åŒ¹é…
                    // - æœ "Zhang Chen" (zhangchen) === "Zhang Chen" (zhangchen) -> åŒ¹é…
                    if(dbName === cleanTerm || dbId === cleanTerm) {
                        foundData = s;
                        break; // æ‰¾åˆ°å”¯ä¸€çš„ç²¾ç¡®åŒ¹é…é¡¹ï¼Œåœæ­¢å¾ªç¯
                    }
                }

                // ç»“æœæ¸²æŸ“é€»è¾‘
                if(foundData) {
                    renderResult(foundData);
                } else {
                    // æœªæ‰¾åˆ°åŒ¹é…é¡¹
                    card.style.display = 'none';
                    const msgBox = document.getElementById('messageBox');
                    msgBox.style.display = 'block';

                    // åŒè¯­æç¤º
                    const isEn = localStorage.getItem('app_lang') === 'en';
                    document.getElementById('messageText').textContent = isEn
                        ? 'No exact match found'
                        : 'æœªæ‰¾åˆ°è¯¥å­¦ç”Ÿæ¡£æ¡ˆ (è¯·å°è¯•è¾“å…¥å…¨å)';
                }
            }, 300); // æ¨¡æ‹ŸæŸ¥è¯¢å»¶è¿ŸåŠ¨ç”»
        });
    }

    // ============================================================
    // 3. å¯åŠ¨é€»è¾‘
    // ============================================================
    (async function() {
        const currentLang = localStorage.getItem('app_lang') || 'cn';

        // ã€ä¿®å¤ã€‘é˜²æ­¢ç«æ€ï¼šä»…å½“é…ç½®ä¸å­˜åœ¨æ—¶æ‰ä¸»åŠ¨åŠ è½½
        // lang-switch.js å¯èƒ½ä¼šè‡ªåŠ¨è§¦å‘ reloadConfig
        if (!window.SchoolSystemConfig) {
            await window.reloadConfig(currentLang);
        } else {
            // å¦‚æœé…ç½®å·²å­˜åœ¨ï¼ˆä¾‹å¦‚ä»å…¶ä»–é¡µé¢å¸¦è¿‡æ¥ï¼Œæˆ– lang-switch æé€ŸåŠ è½½äº†ï¼‰ï¼Œç›´æ¥åˆå§‹åŒ– UI
            initApp();
        }

        // ç»‘å®šé€€å‡ºæŒ‰é’®
        document.getElementById('logoutBtn').addEventListener('click', () => {
            sessionStorage.clear();
            window.location.href = 'index.html';
        });
    })();
</script>
</body>
</html>