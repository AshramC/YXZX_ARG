<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>监控视图 - 异象中学</title>
    <link rel="stylesheet" href="monitor-style.css">
</head>
<body>

<div class="layout-container">
    <aside class="sidebar">
        <div class="brand">
            <span class="lang-cn-only">异象中学监控</span>
            <span class="lang-en-only">ANOMALY HIGH CCTV</span>
        </div>

        <div style="margin-bottom: 1rem; border-bottom: 1px solid #333; padding-bottom: 1rem;">
            <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">
                <span class="lang-cn-only">ARCHIVE DATE / 档案日期</span>
                <span class="lang-en-only">ARCHIVE DATE</span>
            </div>
            <select id="dateSelector" class="btn" style="width: 100%; text-align: left;" onchange="switchDate(this.value)">
            </select>
        </div>

        <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">CAMERAS / 地点列表</div>
        <div id="mapList"></div>

        <div style="margin-top: auto;">
            <div id="userInfo" style="margin-bottom: 1rem; font-size: 0.8rem; color: var(--cctv-green);">
                OPERATOR: --
            </div>
            <button onclick="logout()" class="btn" style="width: 100%;">LOGOUT</button>
            <div style="margin-top: 1rem;">
                <select class="lang-selector btn" style="width: 100%;">
                    <option value="cn">中文</option>
                    <option value="en">English</option>
                </select>
            </div>
        </div>
    </aside>

    <main class="main-view">

        <div id="deduce-btn-container" style="display:none;">
            <button id="btn-deduce-trigger" class="btn" style="padding: 10px 20px; border-color: var(--cctv-text);">
                <span class="lang-cn-only">✦ 推断藏身处</span>
                <span class="lang-en-only">✦ DEDUCE LOCATION</span>
            </button>
        </div>

        <div class="monitor-screen" id="screenContainer">
            <div style="color: #444;">NO SIGNAL</div>
        </div>

        <div class="control-bar">
            <button id="playBtn" class="btn" onclick="togglePlay()">▶ PLAY</button>

            <div style="flex: 1; display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #666; margin-bottom: 4px;">
                    <span id="labelStart">08:00</span>
                    <span id="labelEnd">18:00</span>
                </div>
                <input type="range" id="timeSlider" min="8" max="18" step="0.001" value="8" oninput="updateTimeFromSlider(this.value)">
            </div>

            <div class="time-display">
                <span id="displayTime">08:00</span>
            </div>
        </div>
    </main>
</div>

<div id="quiz-modal" class="modal-overlay" style="display: none;">
    <div class="modal-box">
        <h3 id="quiz-question">
        </h3>
        <div id="quiz-options" class="options-list">
        </div>
        <div style="margin-top: 2rem;">
            <button id="btn-quiz-cancel" class="btn" style="border-color: #444; color: #666;">
                <span class="lang-cn-only">取消</span><span class="lang-en-only">CANCEL</span>
            </button>
        </div>
    </div>
</div>

<div id="sys-notification" class="sys-screen" style="display: none;">
    <div class="sys-content">
        <div class="sys-header">
            <div class="sys-title">系统通知</div>
            <div style="color: var(--cctv-green);">状态：已确认</div>
        </div>

        <div class="msg-meta">
            <div class="msg-row">
                <span class="msg-label">事件类型：</span>
                <span class="msg-val">加密信号拦截</span>
            </div>
            <div class="msg-row">
                <span class="msg-label">发送方：</span>
                <span class="msg-val hacker">未知来源 (匿名黑客)</span>
            </div>
            <div class="msg-row">
                <span class="msg-label">接收账号：</span>
                <span class="msg-val user">吴宇 (ID: 2023012064)</span>
            </div>
            <div class="msg-row">
                <span class="msg-label">信号定位：</span>
                <span class="msg-val">图书馆区域 (Academic Zone)</span>
            </div>
        </div>

        <div class="instruction-text">
            <p style="font-size: 1.1rem; line-height: 1.8; color: #bbb;">
                系统已拦截到一条针对该账户的定向加密留言。<br>
                由于安全协议限制，该消息无法在监控系统内解码。<br><br>

                请立即登录 <span class="highlight-terminal">聊天终端</span> 查看完整内容。
            </p>
        </div>

        <button id="btn-sys-confirm" class="btn" style="width: 100%; padding: 1rem; margin-top: 1rem;">
            关闭通知
        </button>
    </div>
</div>

<script src="../tools/decrypt-lib.js"></script>
<script src="../tools/lang-switch.js"></script>
<script src="../tools/config-loader.js"></script>
<script src="../tools/monitor-generator.js"></script>
<script>
    // === 核心变量 ===
    let currentMapId = null;
    let currentDate = null;
    let currentTime = 8.000;
    let isPlaying = false;
    let animationFrameId = null;
    let lastTimestamp = 0;

    const DURATION_PER_HOUR = 10000;

    // === 工具函数 ===
    function getHashSeed(str) {
        let val = 0;
        for (let i = 0; i < str.length; i++) {
            val = ((val << 5) - val) + str.charCodeAt(i);
            val |= 0;
        }
        return Math.abs(val);
    }

    function getStableOffset(str) {
        const seed = getHashSeed(str);
        return { x: Math.sin(seed) * 1.5, y: Math.cos(seed) * 1.5 };
    }

    function getStableExitPoint(name, timeIndex) {
        let seed = timeIndex + getHashSeed(name);
        const rand = (Math.sin(seed) * 10000) - Math.floor(Math.sin(seed) * 10000);
        const side = Math.floor(rand * 4);
        const position = (rand * 100) % 100;
        switch(side) {
            case 0: return { x: position, y: -10 };
            case 1: return { x: 110, y: position };
            case 2: return { x: position, y: 110 };
            case 3: return { x: -10, y: position };
        }
        return { x: -10, y: -10 };
    }

    function getPersonalDelay(name) {
        if (!name) return 0;
        const seed = getHashSeed(name);
        return (seed % 20) / 100.0;
    }

    // === 区域坐标计算 ===
    function getZoneDynamicPosition(mapId, zoneId, charName, timeFloat, arrivalHour) {
        if (!MapConfig[mapId]) return null;
        const zone = MapConfig[mapId].zones.find(z => z.id === zoneId);
        if (!zone) return null;

        const centerX = zone.x + zone.w / 2;
        const centerY = zone.y + zone.h / 2;

        if (zone.pathType === 'ellipse') {
            const rx = zone.w / 2;
            const ry = zone.h / 2;
            const speed = 5.0;
            const personalOffset = getHashSeed(charName) % 100;
            const angle = (timeFloat * speed) + personalOffset;
            return { x: centerX + rx * Math.cos(angle), y: centerY + ry * Math.sin(angle) };
        }

        if (zone.pathType === 'linear-h' || zone.pathType === 'linear-v') {
            const delay = getPersonalDelay(charName);
            const elapsed = timeFloat - arrivalHour - delay;
            const duration = 0.5;
            const progress = Math.max(0, Math.min(1, elapsed / duration));
            const direction = zone.direction || 1;
            const jitterBase = (getHashSeed(charName) % 10) / 5.0;
            const currentJitter = progress >= 1 ? jitterBase : 0;

            if (zone.pathType === 'linear-h') {
                const startX = direction === 1 ? zone.x : (zone.x + zone.w);
                const totalDistance = direction === 1 ? zone.w : -zone.w;
                return { x: startX + (totalDistance * progress), y: centerY + currentJitter };
            } else {
                const startY = direction === 1 ? zone.y : (zone.y + zone.h);
                const totalDistance = direction === 1 ? zone.h : -zone.h;
                return { x: centerX + currentJitter, y: startY + (totalDistance * progress) };
            }
        }
        return { x: centerX, y: centerY, isStatic: true };
    }

    // === [关键修改 1] 增强的配置加载器 ===
    window.reloadConfig = async function(lang) {
        try {
            // 加载基础配置
            await UnifiedLoader.load('monitor-config', 'MonitorConfig', 'ENCRYPTED_MONITOR_CONFIG', lang);
            await UnifiedLoader.load('maps-config', 'MapConfig', 'ENCRYPTED_MAP_CONFIG', lang);
            await UnifiedLoader.load('../school-system/school-config', 'SchoolSystemConfig', 'ENCRYPTED_SCHOOL_CONFIG', lang);
            await UnifiedLoader.load('../school-system/characters-config', 'CharacterConfig', 'ENCRYPTED_CHAR_CONFIG', lang);

            // 运行生成器 (传入刚刚加载的 CharacterConfig)
            if (window.MonitorGenerator) {
                window.MonitorGenerator.run(
                    window.MonitorConfig,
                    window.SchoolSystemConfig,
                    window.MapConfig,
                    window.CharacterConfig // <--- 关键传入
                );
            }

            initSystem();
        } catch(e) { console.error("Config Load Error:", e); }
    };

    // ============================================================
    // 【新功能】推理与引导模块
    // ============================================================
    function initDeductionModule() {
        // 1. 检查 DOM 元素是否存在
        const triggerContainer = document.getElementById('deduce-btn-container');
        const triggerBtn = document.getElementById('btn-deduce-trigger');
        const modal = document.getElementById('quiz-modal');
        const optionsContainer = document.getElementById('quiz-options');
        const sysScreen = document.getElementById('sys-notification');

        if (!triggerBtn || !modal) return;

        // 显示入口按钮
        triggerContainer.style.display = 'block';

        // 2. 配置数据
        const quizConfig = {
            correctId: "mc_tsg", // 图书馆
            wrongIds: ["z_top", "mc_rubbish", "mc_ds"], // 干扰项
            question: {
                cn: "根据目前的线索，张晨究竟藏在哪里？",
                en: "Based on current clues, where is Zhang Chen hiding?"
            }
        };

        // 3. 辅助：从 MapConfig 获取双语名称
        // MapConfig 结构是 { mapId: { zones: [ {id, name:{cn,en}}, ... ] } }
        function getZoneNameObj(zoneId) {
            if (!window.MapConfig) return { cn: "未知", en: "Unknown" };

            for (const mapKey in MapConfig) {
                const map = MapConfig[mapKey];
                if (map.zones) {
                    const zone = map.zones.find(z => z.id === zoneId);
                    if (zone) {
                        // 兼容 name 是对象 {cn, en} 或 纯字符串的情况
                        if (typeof zone.name === 'object') return zone.name;
                        return { cn: zone.name, en: zone.name };
                    }
                }
            }
            return { cn: "未知区域", en: "Unknown Area" };
        }

        // 4. 打开弹窗逻辑
        triggerBtn.onclick = () => {
            modal.style.display = 'flex';
            const lang = localStorage.getItem('app_lang') || 'cn';

            // 设置问题
            const qText = document.getElementById('quiz-question');
            qText.textContent = (lang === 'en') ? quizConfig.question.en : quizConfig.question.cn;

            // 准备选项
            let options = [];
            // 正确项
            options.push({ id: quizConfig.correctId, ...getZoneNameObj(quizConfig.correctId), isCorrect: true });
            // 错误项
            quizConfig.wrongIds.forEach(id => {
                options.push({ id: id, ...getZoneNameObj(id), isCorrect: false });
            });

            // 打乱数组
            options.sort(() => Math.random() - 0.5);

            // 渲染按钮
            optionsContainer.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'quiz-btn';

                // 显示名字
                const nameDisplay = (lang === 'en') ? opt.en : opt.cn;
                // 英文模式下不显示括号，中文模式下如果英文名存在则显示
                const subText = (lang !== 'en' && opt.en) ? ` <span style="font-size:0.8em; opacity:0.6;">(${opt.en})</span>` : '';

                btn.innerHTML = `[${String.fromCharCode(65 + options.indexOf(opt))}] ${nameDisplay}${subText}`;

                btn.onclick = () => handleAnswer(opt.isCorrect);
                optionsContainer.appendChild(btn);
            });
        };

        // 5. 关闭/取消
        document.getElementById('btn-quiz-cancel').onclick = () => {
            modal.style.display = 'none';
        };

        // 6. 处理回答
        function handleAnswer(isCorrect) {
            const lang = localStorage.getItem('app_lang') || 'cn';
            if (isCorrect) {
                modal.style.display = 'none';
                showSuccess();
            } else {
                const msg = (lang === 'en')
                    ? "Analysis failed: Subject trace not found in this sector."
                    : "分析失败：目标未在该区域留下痕迹。";
                alert(msg);
            }
        }

        // 7. 成功后的流程
        function showSuccess() {
            sysScreen.style.display = 'flex';
            // 重新触发一次语言显示，确保通知页内的 lang-cn-only 等类名生效
            if (window.updateLangFromStorage) {
                // 如果你有封装好的更新函数
                // window.updateLangFromStorage();
            } else {
                // 简单的手动触发 (根据 body class)
                const lang = localStorage.getItem('app_lang') || 'cn';
                document.body.className = (lang === 'en') ? 'lang-en' : 'lang-cn';
            }
        }

        // 8. 最终确认：设置标志位并关闭弹窗
        document.getElementById('btn-sys-confirm').onclick = () => {
            // 1. 剧情进度：找到张晨
            localStorage.setItem('flag_found_zhang_chen', 'true');
            // 2. 聊天红点：吴宇有新消息（提示玩家去聊天APP）
            localStorage.setItem('has_new_msg_wuyu', 'true');

            // 3. 仅关闭弹窗，不再跳转
            sysScreen.style.display = 'none';
        };
    }

    function initSystem() {
        const userStr = sessionStorage.getItem('monitor_user');
        if (!userStr) { window.location.href = 'monitor-login.html'; return; }

        let currentUser = JSON.parse(userStr);
        if (window.MonitorConfig && window.MonitorConfig.accounts) {
            const freshUser = MonitorConfig.accounts.find(a => a.id === currentUser.id);
            if (freshUser) currentUser = freshUser;
        }

        // 简单的名字显示逻辑
        const uName = (typeof currentUser.displayName === 'object') ?
            (currentUser.displayName.cn || currentUser.id) : currentUser.displayName;
        document.getElementById('userInfo').textContent = `OPERATOR: ${uName}`;

        const settings = MonitorConfig.settings || { startHour: 8, endHour: 18 };
        const slider = document.getElementById('timeSlider');
        slider.min = settings.startHour;
        slider.max = settings.endHour;
        document.getElementById('labelStart').textContent = formatTime(settings.startHour);
        document.getElementById('labelEnd').textContent = formatTime(settings.endHour);

        initDateSelector();
        renderMapList();

        if (currentMapId && MapConfig[currentMapId]) {
            switchMap(currentMapId);
        } else {
            const firstMapId = Object.keys(MapConfig)[0];
            if (firstMapId) switchMap(firstMapId);
        }

        currentTime = settings.startHour;
        slider.value = currentTime;
        document.getElementById('displayTime').textContent = formatTime(currentTime);
        updateScene(currentTime);

        initDeductionModule();
    }

    function initDateSelector() {
        const selector = document.getElementById('dateSelector');
        selector.innerHTML = '';
        const scenes = MonitorConfig.scenes || {};
        const dates = Object.keys(scenes).sort();
        const lang = localStorage.getItem('app_lang') || 'cn';

        if (dates.length === 0) {
            const opt = document.createElement('option');
            opt.text = lang === 'en' ? "NO DATA" : "暂无数据";
            selector.add(opt);
            return;
        }
        dates.forEach(dateStr => {
            const opt = document.createElement('option');
            opt.value = dateStr;
            opt.text = dateStr;
            selector.add(opt);
        });
        currentDate = dates.includes(currentDate) ? currentDate : dates[0];
        selector.value = currentDate;
    }

    function switchDate(newDate) {
        currentDate = newDate;
        stopPlay();
        const btn = document.getElementById('playBtn');
        btn.textContent = "▶ PLAY";
        btn.style.background = "black";
        btn.style.color = "var(--cctv-green)";

        currentTime = MonitorConfig.settings.startHour;
        document.getElementById('timeSlider').value = currentTime;
        document.getElementById('displayTime').textContent = formatTime(currentTime);
        updateScene(currentTime);
    }

    function renderMapList() {
        const listEl = document.getElementById('mapList');
        listEl.innerHTML = '';
        Object.values(MapConfig).forEach(map => {
            const div = document.createElement('div');
            div.className = 'map-list-item';
            div.id = `nav-${map.id}`;
            div.textContent = map.name;
            div.onclick = () => switchMap(map.id);
            listEl.appendChild(div);
        });
    }

    function switchMap(mapId) {
        currentMapId = mapId;
        document.querySelectorAll('.map-list-item').forEach(el => el.classList.remove('active'));
        const activeItem = document.getElementById(`nav-${mapId}`);
        if(activeItem) activeItem.classList.add('active');
        renderMapFrame();
        updateScene(currentTime);
    }

    function renderMapFrame() {
        const container = document.getElementById('screenContainer');
        const mapData = MapConfig[currentMapId];
        if (!mapData) return;

        container.innerHTML = '';
        const mapLayer = document.createElement('div');
        mapLayer.className = 'map-layer';
        mapLayer.id = 'currentMapLayer';
        mapLayer.style.width = '100%';
        mapLayer.style.aspectRatio = `${mapData.width} / ${mapData.height}`;

        if (mapData.zones) {
            mapData.zones.forEach(zone => {
                const box = document.createElement('div');
                box.className = zone.type === 'circle' ? 'zone-circle' : 'zone-rect';
                box.style.left = zone.x + '%';
                box.style.top = zone.y + '%';
                box.style.width = zone.w + '%';
                box.style.height = zone.h + '%';
                box.dataset.zoneId = zone.id;

                const label = document.createElement('div');
                label.className = 'zone-label';
                label.style.left = zone.x + '%';
                label.style.top = zone.y + '%';
                label.style.width = zone.w + '%';
                label.style.height = zone.h + '%';
                label.textContent = zone.name;

                mapLayer.appendChild(box);
                mapLayer.appendChild(label);
            });
        }
        container.appendChild(mapLayer);
    }

    // === [关键修改 2] 渲染场景与名字翻译 ===
    function updateScene(timeFloat) {
        if (!currentMapId || !currentDate) return;
        const mapLayer = document.getElementById('currentMapLayer');
        if (!mapLayer) return;

        mapLayer.querySelectorAll('.char-dot').forEach(el => el.remove());

        const dateData = MonitorConfig.scenes[currentDate];
        if (!dateData) return;
        const sceneData = dateData[currentMapId];
        if (!sceneData) return;

        const startHour = MonitorConfig.settings.startHour;
        const relativeTime = timeFloat - startHour;
        const prevIndex = Math.floor(relativeTime);
        const nextIndex = (prevIndex + 1) % 24;
        const ratio = relativeTime - prevIndex;

        // 辅助：获取到达时间
        const getArrivalHour = (track, idx) => {
            if (idx < 0) return startHour;
            const currentZone = track[idx];
            if (!currentZone || currentZone === 'DISAPPEAR') return startHour + idx;
            let i = idx;
            while (i > 0 && track[i - 1] === currentZone) i--;
            return startHour + i;
        };

        const getRawPos = (zoneId, t, arrT, charName) => {
            if (!zoneId || zoneId === 'DISAPPEAR') return null;
            return getZoneDynamicPosition(currentMapId, zoneId, charName, t, arrT);
        }

        sceneData.forEach(char => {
            if (!char.track) return;
            const zoneIdPrev = char.track[prevIndex];
            const zoneIdNext = char.track[nextIndex];

            if (nextIndex < prevIndex && zoneIdPrev === 'DISAPPEAR') return;

            const arrTimePrev = getArrivalHour(char.track, prevIndex);
            const arrTimeNext = getArrivalHour(char.track, nextIndex);

            const tPrev = (zoneIdPrev === zoneIdNext) ? timeFloat : (startHour + prevIndex);
            const tNext = (zoneIdPrev === zoneIdNext) ? timeFloat : (startHour + nextIndex);

            let posPrev = getRawPos(zoneIdPrev, tPrev, arrTimePrev, char.name);
            let posNext = getRawPos(zoneIdNext, tNext, arrTimeNext, char.name);

            if (posPrev && !posNext) if (zoneIdNext !== 'DISAPPEAR') posNext = getStableExitPoint(char.name, prevIndex);
            if (!posPrev && posNext) posPrev = getStableExitPoint(char.name, nextIndex);
            if (!posPrev || !posNext) return;

            let finalX, finalY;
            if (zoneIdPrev === zoneIdNext && posPrev) {
                finalX = posPrev.x; finalY = posPrev.y;
            } else {
                const delay = getPersonalDelay(char.name);
                let adjustedRatio = Math.max(0, Math.min(1, (ratio - delay) / (1.0 - delay)));
                finalX = posPrev.x + (posNext.x - posPrev.x) * adjustedRatio;
                finalY = posPrev.y + (posNext.y - posPrev.y) * adjustedRatio;
            }

            if (posPrev && posPrev.isStatic && zoneIdPrev === zoneIdNext) {
                const offset = getStableOffset(char.name);
                finalX += offset.x; finalY += offset.y;
            }

            const dot = document.createElement('div');
            dot.className = 'char-dot';
            dot.style.backgroundColor = char.color;
            dot.style.color = char.color;
            dot.style.left = finalX + '%';
            dot.style.top = finalY + '%';

            // === [核心逻辑] 名字最终解析 ===
            // 1. 获取生成器传来的名字 (可能是字符串 'zhangchen' 或对象 {cn:..., en:...})
            let displayName = char.name;

            // 2. 如果是对象 (说明 generator 成功解析了)，取当前语言
            if (typeof displayName === 'object') {
                const lang = localStorage.getItem('app_lang') || 'cn';
                displayName = displayName[lang] || displayName['cn'] || '???';
            }
            // 3. 如果还是字符串 (说明是 ID, 如 'zhangchen')，尝试去 CharacterConfig 查表 (兜底策略)
            else if (window.CharacterConfig && window.CharacterConfig[displayName]) {
                displayName = window.CharacterConfig[displayName];
            }

            dot.setAttribute('data-name', displayName);
            mapLayer.appendChild(dot);
        });
    }

    function formatTime(floatHour) {
        const h = Math.floor(floatHour);
        const m = Math.floor((floatHour - h) * 60);
        return `${h < 10 ? '0'+h : h}:${m < 10 ? '0'+m : m}`;
    }

    function updateTimeFromSlider(val) {
        currentTime = parseFloat(val);
        document.getElementById('displayTime').textContent = formatTime(currentTime);
        updateScene(currentTime);
    }

    function togglePlay() {
        if (isPlaying) stopPlay(); else startPlay();
        const btn = document.getElementById('playBtn');
        btn.textContent = isPlaying ? "❚❚ STOP" : "▶ PLAY";
        btn.style.background = isPlaying ? "var(--cctv-green)" : "black";
        btn.style.color = isPlaying ? "black" : "var(--cctv-green)";
    }

    function startPlay() {
        if (isPlaying) return;
        isPlaying = true;
        lastTimestamp = performance.now();
        animationFrameId = requestAnimationFrame(gameLoop);
    }
    function stopPlay() {
        isPlaying = false;
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
    }
    function gameLoop(timestamp) {
        if (!isPlaying) return;
        const deltaTime = timestamp - lastTimestamp;
        lastTimestamp = timestamp;
        currentTime += deltaTime / DURATION_PER_HOUR;
        if (currentTime > MonitorConfig.settings.endHour) currentTime = MonitorConfig.settings.startHour;
        document.getElementById('timeSlider').value = currentTime;
        document.getElementById('displayTime').textContent = formatTime(currentTime);
        updateScene(currentTime);
        animationFrameId = requestAnimationFrame(gameLoop);
    }
    function logout() {
        sessionStorage.removeItem('monitor_user');
        window.location.href = 'monitor-login.html';
    }

    (async function(){
        const lang = localStorage.getItem('app_lang') || 'cn';
        if (!window.MonitorConfig) await window.reloadConfig(lang);
        else initSystem();
    })();
</script>
</body>
</html>