<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™»å½• - å¼‚è±¡ä¸­å­¦å†…éƒ¨é‚®ä»¶ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="mail-style.css">
</head>
<body>

<div class="login-wrapper">
  <div class="login-brand">
    <div style="font-size: 2.8rem; font-weight: 700; margin-bottom: 0.5rem; line-height: 1.2;">
      <span class="lang-cn-only">å¼‚è±¡ä¸­å­¦<br>å†…éƒ¨é‚®ä»¶ç³»ç»Ÿ</span>
      <span class="lang-en-only">Anomaly High<br>Internal Mail System</span>
    </div>
    <div style="font-size: 0.95rem; opacity: 0.85; margin-top: 1.5rem; line-height: 1.6;">
      <p style="margin: 0.5rem 0;">
        <span class="lang-cn-only">ğŸ“§ ç”¨äºæ¥æ”¶æ ¡æ–¹é€šçŸ¥ã€ä½œä¸šå¸ƒç½®åŠé‡è¦æ–‡ä»¶</span>
        <span class="lang-en-only">ğŸ“§ For official notices, assignments, and documents.</span>
      </p>
      <p style="margin: 0.5rem 0;">
        <span class="lang-cn-only">ğŸ”’ é‚®ä»¶å†…å®¹å—å­¦æ ¡ä¿¡æ¯ç®¡ç†åˆ¶åº¦ä¿æŠ¤</span>
        <span class="lang-en-only">ğŸ”’ Contents are protected by school information policy.</span>
      </p>
      <p style="margin: 0.5rem 0; font-size: 0.85rem; opacity: 0.7;">
        <span class="lang-cn-only">ç®¡ç†å•ä½ï¼šæ•™åŠ¡å¤„ | ä¸Šçº¿æ—¶é—´ï¼š2023å¹´9æœˆ</span>
        <span class="lang-en-only">Admin: Academic Affairs | Since Sep 2023</span>
      </p>
    </div>
  </div>

  <div class="login-form" style="position: relative;">

    <div class="lang-switch-wrapper">
      <select class="lang-selector">
        <option value="cn">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
      </select>
    </div>

    <div style="width: 100%; max-width: 360px;">
      <h2 style="margin-bottom: 2rem; font-size: 1.8rem; color: var(--text-main);">
        <span class="lang-cn-only">é‚®ç®±ç™»å½•</span>
        <span class="lang-en-only">Email Login</span>
      </h2>

      <form id="loginForm">
        <div style="margin-bottom: 1.5rem;">
          <label style="display:block; margin-bottom:0.5rem; font-weight:600; color:var(--text-muted); font-size:0.9rem;">
            <span class="lang-cn-only">é‚®ç®±åœ°å€</span>
            <span class="lang-en-only">Email Address</span>
          </label>
          <input type="text" id="email" class="search-input i18n-attr" style="background:#f8fafc;"
                 required
                 data-attr="placeholder"
                 data-cn="name@edu.com"
                 data-en="name@edu.com"
                 placeholder="name@edu.com">
        </div>

        <div style="margin-bottom: 2rem;">
          <label style="display:block; margin-bottom:0.5rem; font-weight:600; color:var(--text-muted); font-size:0.9rem;">
            <span class="lang-cn-only">å¯†ç </span>
            <span class="lang-en-only">Password</span>
          </label>
          <div style="position: relative;">
            <input type="password" id="password" class="search-input i18n-attr" style="background:#f8fafc; padding-right: 3rem;"
                   required
                   data-attr="placeholder"
                   data-cn="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                   data-en="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                   placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            <button type="button" id="togglePassword" style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 0.25rem; display: flex; align-items: center; justify-content: center;" title="æ˜¾ç¤º/éšè—å¯†ç ">
              <svg id="eyeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </button>
          </div>
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 1rem; font-size: 1rem;">
          <span class="lang-cn-only">ç«‹å³ç™»å½•</span>
          <span class="lang-en-only">Login</span>
        </button>

        <div style="text-align: center;">
          <span id="forgotBtn" class="link-btn">
            <span class="lang-cn-only">å¿˜è®°å¯†ç ï¼Ÿ</span>
            <span class="lang-en-only">Forgot Password?</span>
          </span>
        </div>

        <div id="errorMessage" style="display:none; margin-top:1rem; padding:0.75rem; background:#fef2f2; color:var(--danger); border-radius:0.5rem; text-align:center; font-size:0.9rem;">
          <span class="lang-cn-only">é‚®ç®±åœ°å€æˆ–å¯†ç é”™è¯¯</span>
          <span class="lang-en-only">Invalid email or password</span>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="forgotModal" class="modal-overlay">
  <div class="modal-card">
    <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem;">
      <h3 style="font-size:1.2rem; font-weight:700;">
        <span class="lang-cn-only">å®‰å…¨ä¸­å¿ƒ - æ‰¾å›å¯†ç </span>
        <span class="lang-en-only">Security Center - Recovery</span>
      </h3>
      <button id="closeModal" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
    </div>

    <div id="step1" class="step-group active">
      <p style="color:var(--text-muted); margin-bottom:1rem; font-size:0.9rem;">
        <span class="lang-cn-only">è¯·è¾“å…¥æ‚¨çš„<strong>å­¦å·</strong>ä»¥éªŒè¯èº«ä»½ï¼š</span>
        <span class="lang-en-only">Enter your <strong>Student ID</strong> to verify:</span>
      </p>
      <input type="text" id="verifyId" class="search-input i18n-attr"
             data-attr="placeholder" data-cn="ä¾‹å¦‚ï¼š202301..." data-en="e.g. 202301..."
             placeholder="ä¾‹å¦‚ï¼š202301..." style="margin-bottom:1rem;">
      <button id="btnVerifyId" class="btn btn-primary" style="width:100%;">
        <span class="lang-cn-only">ä¸‹ä¸€æ­¥</span>
        <span class="lang-en-only">Next</span>
      </button>
      <div id="errorStep1" style="display:none; color:var(--danger); margin-top:0.5rem; font-size:0.85rem; background:#fef2f2; padding:0.5rem; border-radius:4px;"></div>
    </div>

    <div id="step2" class="step-group">
      <p style="color:var(--text-muted); font-size:0.85rem;">
        <span class="lang-cn-only">ä¸ºäº†æ‚¨çš„è´¦æˆ·å®‰å…¨ï¼Œè¯·å›ç­”å®‰å…¨é—®é¢˜ï¼š</span>
        <span class="lang-en-only">Please answer the security question:</span>
      </p>
      <div id="questionText" style="font-weight:700; font-size:1.05rem; margin:0.8rem 0 1.2rem 0; color:var(--text-main); line-height:1.4;">--</div>
      <input type="text" id="verifyAnswer" class="search-input i18n-attr"
             data-attr="placeholder" data-cn="åœ¨æ­¤è¾“å…¥ç­”æ¡ˆ" data-en="Enter answer here"
             placeholder="åœ¨æ­¤è¾“å…¥ç­”æ¡ˆ" style="margin-bottom:1rem;">
      <button id="btnVerifyAns" class="btn btn-primary" style="width:100%;">
        <span class="lang-cn-only">éªŒè¯ç­”æ¡ˆ</span>
        <span class="lang-en-only">Verify</span>
      </button>
      <div id="errorStep2" style="display:none; color:var(--danger); font-size:0.85rem; margin-top:0.8rem; background:#fef2f2; padding:0.5rem; border-radius:4px;">
        <span class="lang-cn-only">ç­”æ¡ˆé”™è¯¯ï¼Œè¯·é‡è¯•</span>
        <span class="lang-en-only">Incorrect answer, please try again</span>
      </div>
    </div>

    <div id="step3" class="step-group" style="text-align:center;">
      <div style="font-size:3.5rem; margin-bottom:1rem;">ğŸ”“</div>
      <p style="color:var(--text-muted);">
        <span class="lang-cn-only">èº«ä»½éªŒè¯é€šè¿‡ï¼Œæ‚¨çš„å½“å‰å¯†ç æ˜¯ï¼š</span>
        <span class="lang-en-only">Identity Verified. Your password is:</span>
      </p>
      <div id="showPassword" style="font-size:1.8rem; font-weight:800; color:var(--primary); margin:1.5rem 0; letter-spacing: 2px; background:#f0fdfa; padding:1rem; border-radius:0.5rem; user-select:all;">--</div>
      <button id="btnDone" class="btn btn-ghost" style="width:100%;">
        <span class="lang-cn-only">è¿”å›ç™»å½•</span>
        <span class="lang-en-only">Back to Login</span>
      </button>
    </div>
  </div>
</div>

<script src="../tools/decrypt-lib.js"></script>
<script src="../tools/lang-switch.js"></script>
<script src="../tools/config-loader.js"></script>

<script>
  function loadScript(src) {
    return new Promise((resolve, reject) => {
      // ç§»é™¤æ‰€æœ‰æ—§çš„ config è„šæœ¬ï¼Œé˜²æ­¢é‡å¤
      document.querySelectorAll(`script[src*="email-config"]`).forEach(s => s.remove());

      const script = document.createElement('script');
      script.src = src + '?t=' + Date.now();
      script.onload = () => resolve();
      script.onerror = () => reject(new Error(`Failed to load ${src}`));
      document.body.appendChild(script);
    });
  }

  /**
   * åŠ¨æ€åŠ è½½é…ç½®è„šæœ¬
   * å½“ç”¨æˆ·åˆ‡æ¢è¯­è¨€æ—¶ï¼Œlang-switch.js ä¼šè°ƒç”¨æ­¤å‡½æ•°
   */
  window.reloadConfig = async function(lang) {
    try {
      await UnifiedLoader.load(
              'email-config',
              'EmailSystemConfig',
              'ENCRYPTED_EMAIL_CONFIG',
              lang
      );
    } catch(e) {
      console.error("Login Config Load Failed", e);
    }
  };

  /**
   * å…³é”®ä¿®å¤ï¼šå°†äº‹ä»¶ç»‘å®šç§»å‡ºå¼‚æ­¥æµç¨‹ï¼Œé˜²æ­¢å› é…ç½®åŠ è½½é˜»å¡å¯¼è‡´ç‚¹å‡»ç™»å½•åˆ·æ–°é¡µé¢
   */
  document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault(); // 1. ç«‹å³é˜»æ­¢é»˜è®¤è¡Œä¸º

    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value;
    const isEn = localStorage.getItem('app_lang') === 'en';

    // 2. é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿é…ç½®å·²åŠ è½½
    if (!window.EmailSystemConfig || !window.EmailSystemConfig.accounts) {
      alert(isEn ? "System initializing... please wait." : "ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨å€™...");
      return;
    }

    const account = EmailSystemConfig.accounts.find(acc => acc.id === email && acc.password === pass);

    if (account) {
      sessionStorage.setItem('emailSystem_user', account.id);
      sessionStorage.setItem('emailSystem_name', account.displayName);
      window.location.href = 'email-system.html';
    } else {
      const err = document.getElementById('errorMessage');
      err.style.display = 'block';
      setTimeout(() => err.style.display = 'none', 3000);
    }
  });

  // å…¶ä»–åˆå§‹åŒ–é€»è¾‘
  (async function() {
    // 1. åˆå§‹åŒ–é€»è¾‘
    const currentLang = localStorage.getItem('app_lang') || 'cn';

    // å…³é”®ä¼˜åŒ–ï¼šæ£€æŸ¥é…ç½®æ˜¯å¦å·²ç»ç”± lang-switch.js åŠ è½½
    // é˜²æ­¢é‡å¤è¯·æ±‚å’Œç«æ€æ¡ä»¶
    if (!window.EmailSystemConfig) {
      console.log("[Login] Triggering initial config load...");
      await window.reloadConfig(currentLang);
    }

    // 2. å¯†ç æ˜¾ç¤º/éšè—åˆ‡æ¢
    const passwordInput = document.getElementById('password');
    const toggleBtn = document.getElementById('togglePassword');
    const eyeIcon = document.getElementById('eyeIcon');

    toggleBtn.addEventListener('click', function() {
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.innerHTML = `
          <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
          <line x1="1" y1="1" x2="23" y2="23"></line>
        `;
        toggleBtn.style.color = 'var(--primary)';
      } else {
        passwordInput.type = 'password';
        eyeIcon.innerHTML = `
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        `;
        toggleBtn.style.color = 'var(--text-muted)';
      }
    });

    // ==========================================
    // 4. æ‰¾å›å¯†ç é€»è¾‘
    // ==========================================
    const modal = document.getElementById('forgotModal');
    let currentRecoveryAccount = null;

    // æ‰“å¼€å¼¹çª—
    document.getElementById('forgotBtn').onclick = () => {
      modal.style.display = 'flex';
      switchStep(1);
      document.getElementById('verifyId').value = '';
      currentRecoveryAccount = null;
      setTimeout(() => document.getElementById('verifyId').focus(), 100);
    };

    document.getElementById('closeModal').onclick = () => modal.style.display = 'none';
    document.getElementById('btnDone').onclick = () => modal.style.display = 'none';

    function switchStep(step) {
      document.querySelectorAll('.step-group').forEach(el => el.classList.remove('active'));
      document.getElementById(`step${step}`).classList.add('active');
      document.getElementById('errorStep1').style.display = 'none';
      document.getElementById('errorStep2').style.display = 'none';
    }

    // Step 1: éªŒè¯å­¦å·
    document.getElementById('btnVerifyId').onclick = () => {
      const inputId = document.getElementById('verifyId').value.trim();
      const errorDiv = document.getElementById('errorStep1');
      const isEn = localStorage.getItem('app_lang') === 'en';

      if (!window.EmailSystemConfig) {
        alert(isEn ? "System initializing..." : "ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–...");
        return;
      }

      currentRecoveryAccount = EmailSystemConfig.accounts.find(acc => acc.studentId === inputId);

      if (currentRecoveryAccount &&
              currentRecoveryAccount.enableRecovery &&
              currentRecoveryAccount.securityQuestion) {

        document.getElementById('questionText').textContent = currentRecoveryAccount.securityQuestion;

        document.getElementById('verifyAnswer').value = '';
        switchStep(2);
        setTimeout(() => document.getElementById('verifyAnswer').focus(), 100);

      } else {
        errorDiv.style.display = 'block';
        if (currentRecoveryAccount && !currentRecoveryAccount.enableRecovery) {
          errorDiv.textContent = isEn ? "ğŸ”’ Self-recovery not enabled for this account" : "ğŸ”’ è¯¥è´¦æˆ·æœªå¼€é€šè‡ªåŠ©æ‰¾å›åŠŸèƒ½";
        } else {
          errorDiv.textContent = isEn ? "âŒ Student ID not found" : "âŒ æœªæ‰¾åˆ°è¯¥å­¦å·ï¼Œè¯·æ£€æŸ¥è¾“å…¥";
        }
      }
    };

    // Step 2: éªŒè¯å¯†ä¿
    document.getElementById('btnVerifyAns').onclick = () => {
      const inputAns = document.getElementById('verifyAnswer').value.trim();

      if (currentRecoveryAccount && inputAns === currentRecoveryAccount.securityAnswer) {
        document.getElementById('showPassword').textContent = currentRecoveryAccount.password;
        switchStep(3);
      } else {
        document.getElementById('errorStep2').style.display = 'block';
      }
    };

    // å›è½¦é”®æ”¯æŒ
    document.getElementById('verifyId').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('btnVerifyId').click();
    });
    document.getElementById('verifyAnswer').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('btnVerifyAns').click();
    });

  })();
</script>
</body>
</html>