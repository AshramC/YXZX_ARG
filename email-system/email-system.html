<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¶ä»¶ç®± - å†…éƒ¨é‚®ä»¶ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="mail-style.css">
</head>
<body>

<div class="mail-app">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <h2 style="font-size: 1.25rem;">
          <span class="lang-cn-only">æ”¶ä»¶ç®±</span>
          <span class="lang-en-only">Inbox</span>
        </h2>
        <select class="lang-selector" style="padding: 0.2rem 0.5rem; font-size:0.8rem;">
          <option value="cn">CN</option>
          <option value="en">EN</option>
        </select>
      </div>
      <div class="search-wrapper">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="text" id="emailSearchInput" class="search-input i18n-attr"
               data-attr="placeholder"
               data-cn="æŸ¥æ‰¾é‚®ä»¶ã€å‘ä»¶äºº..."
               data-en="Search emails, sender..."
               placeholder="æŸ¥æ‰¾é‚®ä»¶...">
      </div>
    </div>

    <div id="emailList" class="email-list">
    </div>
  </aside>

  <main class="main-view" id="mainView">
    <header class="view-toolbar">
      <div style="font-size: 0.9rem; color: var(--text-muted);">
        <span class="lang-cn-only">å½“å‰ç”¨æˆ·: </span>
        <span class="lang-en-only">User: </span>
        <span id="userEmailDisplay" style="font-weight: 600; color: var(--text-main);">--</span>
      </div>
      <button onclick="logout()" class="btn btn-ghost">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        <span class="lang-cn-only">é€€å‡ºç³»ç»Ÿ</span>
        <span class="lang-en-only">Logout</span>
      </button>
    </header>

    <div id="emailViewContent" class="view-content">
      <div class="empty-state">
        <div class="empty-icon">ğŸ“©</div>
        <h3 style="font-size: 1.2rem; margin-bottom: 0.5rem;">
          <span class="lang-cn-only">æ¬¢è¿ä½¿ç”¨å†…éƒ¨é‚®ä»¶ç³»ç»Ÿ</span>
          <span class="lang-en-only">Welcome to Internal Mail System</span>
        </h3>
        <p>
          <span class="lang-cn-only">è¯·ä»å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹©ä¸€å°é‚®ä»¶å¼€å§‹é˜…è¯»</span>
          <span class="lang-en-only">Select an email from the list to read</span>
        </p>
      </div>
    </div>
  </main>
</div>

<script src="../tools/decrypt-lib.js"></script>
<script src="../tools/lang-switch.js"></script>
<script src="../tools/config-loader.js"></script>

<script>
  // å…¨å±€å˜é‡
  let allUserEmails = [];

  // 1. åŠ¨æ€åŠ è½½è„šæœ¬è¾…åŠ©å‡½æ•°
  function loadScript(src) {
    return new Promise((resolve, reject) => {
      // ç§»é™¤æ‰€æœ‰æ—§çš„ config è„šæœ¬ï¼ˆåŒ…æ‹¬åŠ å¯†ç‰ˆå’Œæ˜æ–‡ç‰ˆï¼‰
      document.querySelectorAll(`script[src*="email-config"]`).forEach(s => s.remove());

      const script = document.createElement('script');
      script.src = src + '?t=' + Date.now();
      script.onload = () => resolve();
      script.onerror = () => reject();
      document.body.appendChild(script);
    });
  }

  // 2. æ ¸å¿ƒé‡è½½å‡½æ•° (ç”± lang-switch.js è°ƒç”¨)
  window.reloadConfig = async function(lang) {
    try {
      // ä½¿ç”¨é€šç”¨åŠ è½½å™¨
      await UnifiedLoader.load(
              'email-config',          // æ–‡ä»¶åå‰ç¼€
              'EmailSystemConfig',     // ç›®æ ‡å˜é‡
              'ENCRYPTED_EMAIL_CONFIG',// åŠ å¯†å˜é‡
              lang                     // å½“å‰è¯­è¨€
      );

      // UI åˆå§‹åŒ–é€»è¾‘ (ä¿æŒåŸæ ·)
      initApp();

      // ä¿æŒé˜…è¯»çŠ¶æ€é€»è¾‘ (ä¿æŒåŸæ ·)
      const activeItem = document.querySelector('.email-item.active');
      if(activeItem) {
        openEmail(activeItem.id.replace('item-', ''));
      } else {
        resetMainView();
      }
    } catch (e) {
      console.error("System Boot Failed:", e);
      alert("æ— æ³•åŠ è½½é‚®ä»¶é…ç½® / Config Load Failed");
    }
  };

  function resetMainView() {
    document.getElementById('emailViewContent').innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ“©</div>
        <h3 style="font-size: 1.2rem; margin-bottom: 0.5rem;">
            ${localStorage.getItem('app_lang')==='en' ? "Welcome" : "æ¬¢è¿ä½¿ç”¨å†…éƒ¨é‚®ä»¶ç³»ç»Ÿ"}
        </h3>
        <p>${localStorage.getItem('app_lang')==='en' ? "Select an email to read" : "è¯·ä»å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹©ä¸€å°é‚®ä»¶å¼€å§‹é˜…è¯»"}</p>
      </div>`;
  }

  // 3. åº”ç”¨åˆå§‹åŒ–
  async function initApp() {
    const currentUserEmail = sessionStorage.getItem('emailSystem_user');

    if (!currentUserEmail) {
      window.location.href = 'email-login.html';
      return;
    }

    // æ›´æ–°ç”¨æˆ·æ˜¾ç¤ºå (ç›´æ¥ä» Config è¯»æœ€æ–°çš„è¯­è¨€ç‰ˆæœ¬)
    const userAccount = EmailSystemConfig.accounts.find(a => a.id === currentUserEmail);
    const displayName = userAccount ? userAccount.displayName : currentUserEmail;
    document.getElementById('userEmailDisplay').textContent = `${displayName} <${currentUserEmail}>`;

    // å‡†å¤‡é‚®ä»¶æ•°æ®
    const userPersonalEmails = EmailSystemConfig.mailboxes[currentUserEmail] || [];
    const commonEmails = EmailSystemConfig.commonEmails || [];

    allUserEmails = [...userPersonalEmails, ...commonEmails].sort((a, b) => {
      const pA = a.priority || 0;
      const pB = b.priority || 0;
      if (pA !== pB) return pB - pA;
      return new Date(b.date) - new Date(a.date);
    });

    // åˆå§‹æ¸²æŸ“
    renderList(getEmailsToDisplay(""));
  }

  // 4. è¿‡æ»¤é€»è¾‘
  function getEmailsToDisplay(keyword = "") {
    const term = keyword.trim().toLowerCase();

    if (!term) return allUserEmails.filter(email => !email.hidden).slice(0, 10);

    return allUserEmails.filter(email => {
      // éšè—é‚®ä»¶åªæœ‰æœä¸­å…³é”®è¯æ‰æ˜¾ç¤º
      if (email.hidden) {
        const definedKeywords = email.keywords || [];
        // æ³¨æ„ï¼šbuild.js ç”Ÿæˆæ—¶ keywords ä¹Ÿä¼šè¢«åˆ†ç¦»
        // å¦‚æœä½ åœ¨ YAML é‡Œ keywords æ˜¯æ•°ç»„ï¼Œè¿™é‡Œç›´æ¥ç”¨
        return definedKeywords.some(k => k.toLowerCase() === term);
      }

      // æ™®é€šé‚®ä»¶æœç´¢ (ç›´æ¥æœå½“å‰è¯­è¨€çš„æ–‡æœ¬)
      const subject = (email.subject || "").toLowerCase();
      const sender = (email.sender || "").toLowerCase();
      return subject.includes(term) || sender.includes(term);
    });
  }

  // 5. æ¸²æŸ“åˆ—è¡¨
  function renderList(emails) {
    const emailListEl = document.getElementById('emailList');
    const isEn = localStorage.getItem('app_lang') === 'en';

    if (emails.length === 0) {
      emailListEl.innerHTML = `<div style="padding:2rem; text-align:center; color:var(--text-muted);">${isEn ? "No emails found" : "æœªæ‰¾åˆ°ç›¸å…³é‚®ä»¶"}</div>`;
      return;
    }

    const itemsHtml = emails.map(email => {
      const isHigh = (email.priority || 0) > 0;
      // ç›´æ¥ä½¿ç”¨ email.sender ç­‰å­—æ®µï¼Œå®ƒä»¬å·²ç»æ˜¯å½“å‰è¯­è¨€çš„å­—ç¬¦ä¸²äº†
      return `
          <div class="email-item ${!email.read ? 'unread' : ''} ${isHigh ? 'high-priority' : ''}"
               onclick="openEmail('${email.id}')" id="item-${email.id}">
            <div class="item-top">
              <span class="item-sender">${email.sender}</span>
              <span class="item-date">${email.date.split(' ')[0]}</span>
            </div>
            <div class="item-subject">${email.subject}</div>
          </div>
        `;
    }).join('');

    const footerHtml = `
        <div class="list-hint">
          ${isEn ? "Showing recent 10 emails" : "ä»…æ˜¾ç¤º10æœ€è¿‘é‚®ä»¶ï¼Œæ›´å¤šå†…å®¹è¯·ä½¿ç”¨ä¸Šæ–¹æœç´¢"}
        </div>
      `;
    emailListEl.innerHTML = itemsHtml + footerHtml;
  }

  // 6. æ‰“å¼€é‚®ä»¶
  window.openEmail = function(id) {
    const email = allUserEmails.find(m => m.id === id);
    if(!email) return;

    // æ ·å¼æ›´æ–°
    document.querySelectorAll('.email-item').forEach(el => el.classList.remove('active'));
    const itemEl = document.getElementById(`item-${id}`);
    if(itemEl) {
      itemEl.classList.add('active');
      itemEl.classList.remove('unread');
    }
    email.read = true;

    // æ¸²æŸ“å†…å®¹ (ç›´æ¥æ’å…¥ï¼ŒConfigé‡Œå·²ç»æ˜¯HTMLå­—ç¬¦ä¸²äº†)
    const emailViewEl = document.getElementById('emailViewContent');
    const isEn = localStorage.getItem('app_lang') === 'en';

    emailViewEl.innerHTML = `
        <div class="mail-header">
            <h1 class="mail-subject">${email.subject}</h1>
            <div class="mail-meta">
                <div class="avatar">${email.sender[0]}</div>
                <div class="meta-info">
                    <div>${email.sender}</div>
                    <div>${email.date}</div>
                </div>
            </div>
        </div>
        <div class="mail-body">
            ${email.content}
        </div>
    `;

    // ç§»åŠ¨ç«¯å¤„ç†
    if(window.innerWidth <= 768) {
      document.getElementById('mainView').classList.add('active');
      // æ·»åŠ è¿”å›æŒ‰é’®
      const backBtn = document.createElement('button');
      backBtn.className = 'btn btn-ghost';
      backBtn.innerHTML = isEn ? 'â† Back' : 'â† è¿”å›åˆ—è¡¨';
      backBtn.style.marginBottom = '1rem';
      backBtn.onclick = () => document.getElementById('mainView').classList.remove('active');
      emailViewEl.prepend(backBtn);
    }
  }

  window.logout = function() {
    sessionStorage.clear();
    window.location.href = 'email-login.html';
  }

  // ç»‘å®šæœç´¢
  document.getElementById('emailSearchInput').addEventListener('input', (e) => {
    renderList(getEmailsToDisplay(e.target.value));
  });

  // å¯åŠ¨
  (async function(){
    const currentLang = localStorage.getItem('app_lang') || 'cn';
    // é¦–æ¬¡åŠ è½½é…ç½®
    await window.reloadConfig(currentLang);
  })();

</script>
</body>
</html>