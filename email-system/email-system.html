<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¶ä»¶ç®± - å†…éƒ¨é‚®ä»¶ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="mail-style.css">
</head>
<body>

<div class="mail-app">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <h2 style="font-size: 1.25rem;">
          <span class="lang-cn-only">æ”¶ä»¶ç®±</span>
          <span class="lang-en-only">Inbox</span>
        </h2>
        <select class="lang-selector" style="padding: 0.2rem 0.5rem; font-size:0.8rem;">
          <option value="cn">CN</option>
          <option value="en">EN</option>
        </select>
      </div>
      <div class="search-wrapper">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="text" id="emailSearchInput" class="search-input i18n-attr"
               data-attr="placeholder"
               data-cn="æŸ¥æ‰¾é‚®ä»¶ã€å‘ä»¶äºº..."
               data-en="Search emails, sender..."
               placeholder="æŸ¥æ‰¾é‚®ä»¶...">
      </div>
    </div>

    <div id="emailList" class="email-list">
    </div>
  </aside>

  <main class="main-view" id="mainView">
    <header class="view-toolbar">
      <div style="font-size: 0.9rem; color: var(--text-muted);">
        <span class="lang-cn-only">å½“å‰ç”¨æˆ·: </span>
        <span class="lang-en-only">User: </span>
        <span id="userEmailDisplay" style="font-weight: 600; color: var(--text-main);">--</span>
      </div>
      <button onclick="logout()" class="btn btn-ghost">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        <span class="lang-cn-only">é€€å‡ºç³»ç»Ÿ</span>
        <span class="lang-en-only">Logout</span>
      </button>
    </header>

    <div id="emailViewContent" class="view-content">
      <div class="empty-state">
        <div class="empty-icon">ğŸ“©</div>
        <h3 style="font-size: 1.2rem; margin-bottom: 0.5rem;">
          <span class="lang-cn-only">æ¬¢è¿ä½¿ç”¨å†…éƒ¨é‚®ä»¶ç³»ç»Ÿ</span>
          <span class="lang-en-only">Welcome to Internal Mail System</span>
        </h3>
        <p>
          <span class="lang-cn-only">è¯·ä»å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹©ä¸€å°é‚®ä»¶å¼€å§‹é˜…è¯»</span>
          <span class="lang-en-only">Select an email from the list to read</span>
        </p>
      </div>
    </div>
  </main>
</div>

<script src="../tools/decrypt-lib.js"></script>
<script src="../tools/lang-switch.js"></script>
<script src="../tools/config-loader.js"></script>

<script>
  // å…¨å±€å˜é‡
  let allUserEmails = [];

  // 1. åŠ¨æ€åŠ è½½è„šæœ¬è¾…åŠ©å‡½æ•°
  function loadScript(src) {
    return new Promise((resolve, reject) => {
      document.querySelectorAll(`script[src*="email-config"]`).forEach(s => s.remove());
      const script = document.createElement('script');
      script.src = src + '?t=' + Date.now();
      script.onload = () => resolve();
      script.onerror = () => reject();
      document.body.appendChild(script);
    });
  }

  // 2. æ ¸å¿ƒé‡è½½å‡½æ•°
  window.reloadConfig = async function(lang) {
    try {
      await UnifiedLoader.load(
              'email-config',
              'EmailSystemConfig',
              'ENCRYPTED_EMAIL_CONFIG',
              lang
      );
      initApp();
      const activeItem = document.querySelector('.email-item.active');
      if(activeItem) {
        openEmail(activeItem.id.replace('item-', ''));
      } else {
        resetMainView();
      }
    } catch (e) {
      console.error("System Boot Failed:", e);
      alert("æ— æ³•åŠ è½½é‚®ä»¶é…ç½® / Config Load Failed");
    }
  };

  function resetMainView() {
    document.getElementById('emailViewContent').innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ“©</div>
        <h3 style="font-size: 1.2rem; margin-bottom: 0.5rem;">
            ${localStorage.getItem('app_lang')==='en' ? "Welcome" : "æ¬¢è¿ä½¿ç”¨å†…éƒ¨é‚®ä»¶ç³»ç»Ÿ"}
        </h3>
        <p>${localStorage.getItem('app_lang')==='en' ? "Select an email to read" : "è¯·ä»å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹©ä¸€å°é‚®ä»¶å¼€å§‹é˜…è¯»"}</p>
      </div>`;
  }

  // 3. åº”ç”¨åˆå§‹åŒ–
  async function initApp() {
    const currentUserEmail = sessionStorage.getItem('emailSystem_user');

    if (!currentUserEmail) {
      window.location.href = 'email-login.html';
      return;
    }

    const userAccount = EmailSystemConfig.accounts.find(a => a.id === currentUserEmail);
    const displayName = userAccount ? userAccount.displayName : currentUserEmail;
    document.getElementById('userEmailDisplay').textContent = `${displayName} <${currentUserEmail}>`;

    const userPersonalEmails = EmailSystemConfig.mailboxes[currentUserEmail] || [];
    const commonEmails = EmailSystemConfig.commonEmails || [];

    // åˆå¹¶æ‰€æœ‰å¯èƒ½é‚®ä»¶ï¼Œä¸éœ€è¦åœ¨æ­¤å¤„æ’åºï¼Œè¿‡æ»¤æ—¶ä¼šå¤„ç†
    allUserEmails = [...userPersonalEmails, ...commonEmails];

    // åˆå§‹æ¸²æŸ“
    renderList(getEmailsToDisplay(""));
  }

  // 4. æ ¸å¿ƒè¿‡æ»¤é€»è¾‘ (ä¿®å¤æ’åºç‰ˆ)
  function getEmailsToDisplay(keyword = "") {
    const term = keyword.trim().toLowerCase();

    // === A. æœç´¢æ¨¡å¼ ===
    if (term) {
      return allUserEmails.filter(email => {
        const hasTrigger = !!email.trigger;
        const isTriggerUnlocked = hasTrigger && localStorage.getItem(email.trigger) === 'true';

        // æœªè§£é”çš„å‰§æƒ…é‚®ä»¶ä¸å¯æœ
        if (hasTrigger && !isTriggerUnlocked) return false;

        if (email.hidden) {
          const definedKeywords = email.keywords || [];
          if (hasTrigger && isTriggerUnlocked) {
            const subject = (email.subject || "").toLowerCase();
            return subject.includes(term) || definedKeywords.some(k => k.toLowerCase() === term);
          }
          return definedKeywords.some(k => k.toLowerCase() === term);
        }

        const subject = (email.subject || "").toLowerCase();
        const sender = (email.sender || "").toLowerCase();
        return subject.includes(term) || sender.includes(term);
      });
    }

    // === B. é»˜è®¤åˆ—è¡¨æ¨¡å¼ (ä¼˜å…ˆçº§åˆ†å±‚) ===

    let eventEmails = []; // å‰§æƒ…è§£é” (Top)
    let highPriority = []; // é«˜ä¼˜ç½®é¡¶ (Middle)
    let normalEmails = []; // æ™®é€šé‚®ä»¶ (Bottom)

    allUserEmails.forEach(email => {
      // 1. å‰§æƒ…è§¦å‘å™¨æ£€æŸ¥
      if (email.trigger) {
        if (localStorage.getItem(email.trigger) === 'true') {
          eventEmails.push(email);
        }
        return;
      }

      // 2. éšè—æ£€æŸ¥
      if (email.hidden) return;

      // 3. æ™®é€šä¼˜å…ˆçº§åˆ†ç±»
      if ((email.priority || 0) > 0) {
        highPriority.push(email);
      } else {
        normalEmails.push(email);
      }
    });

    // åˆ†ç»„å†…æŒ‰æ—¶é—´å€’åº (ä¿è¯ç»„å†…æ˜¯æ–°çš„åœ¨ä¸Šé¢)
    const sortByDate = (a, b) => new Date(b.date) - new Date(a.date);
    eventEmails.sort(sortByDate);
    highPriority.sort(sortByDate);
    normalEmails.sort(sortByDate);

    // å¡«å……é€»è¾‘ (å‡‘å¤Ÿ 10 å°)
    let result = [];
    const MAX_DISPLAY = 10;

    // ä¸¥æ ¼æŒ‰å±‚çº§æ‹¼æ¥ï¼Œä¸å†è¿›è¡Œå…¨å±€é‡æ’åº
    // å±‚çº§ 1: å‰§æƒ…é‚®ä»¶ (ç»å¯¹ç½®é¡¶)
    result = result.concat(eventEmails);

    // å±‚çº§ 2: é«˜ä¼˜é‚®ä»¶ (å¦‚ç³»ç»Ÿé€šçŸ¥ï¼Œå³ä½¿æ—¥æœŸæ—§ä¹Ÿæ˜¾ç¤ºåœ¨æ™®é€šé‚®ä»¶å‰)
    if (result.length < MAX_DISPLAY) {
      const need = MAX_DISPLAY - result.length;
      result = result.concat(highPriority.slice(0, need));
    }

    // å±‚çº§ 3: æ™®é€šé‚®ä»¶
    if (result.length < MAX_DISPLAY) {
      const need = MAX_DISPLAY - result.length;
      result = result.concat(normalEmails.slice(0, need));
    }

    return result; // ã€å…³é”®ä¿®æ”¹ã€‘ç§»é™¤è¿™é‡Œçš„ .sort(sortByDate)
  }

  // 5. æ¸²æŸ“åˆ—è¡¨
  function renderList(emails) {
    const emailListEl = document.getElementById('emailList');
    const isEn = localStorage.getItem('app_lang') === 'en';

    if (emails.length === 0) {
      emailListEl.innerHTML = `<div style="padding:2rem; text-align:center; color:var(--text-muted);">${isEn ? "No emails found" : "æœªæ‰¾åˆ°ç›¸å…³é‚®ä»¶"}</div>`;
      return;
    }

    const itemsHtml = emails.map(email => {
      // è§¦å‘å¼å‰§æƒ…é‚®ä»¶ä¹Ÿè§†ä¸ºé«˜ä¼˜æ˜¾ç¤º
      const isHigh = (email.priority || 0) > 0 || !!email.trigger;
      return `
          <div class="email-item ${!email.read ? 'unread' : ''} ${isHigh ? 'high-priority' : ''}"
               onclick="openEmail('${email.id}')" id="item-${email.id}">
            <div class="item-top">
              <span class="item-sender">${email.sender}</span>
              <span class="item-date">${email.date.split(' ')[0]}</span>
            </div>
            <div class="item-subject">${email.subject}</div>
          </div>
        `;
    }).join('');

    const footerHtml = `
        <div class="list-hint">
          ${isEn ? "Showing recent emails" : "ä»…æ˜¾ç¤ºæœ€è¿‘é‚®ä»¶ï¼Œæ›´å¤šå†…å®¹è¯·ä½¿ç”¨ä¸Šæ–¹æœç´¢"}
        </div>
      `;
    emailListEl.innerHTML = itemsHtml + footerHtml;
  }

  // 6. æ‰“å¼€é‚®ä»¶
  window.openEmail = function(id) {
    const email = allUserEmails.find(m => m.id === id);
    if(!email) return;

    document.querySelectorAll('.email-item').forEach(el => el.classList.remove('active'));
    const itemEl = document.getElementById(`item-${id}`);
    if(itemEl) {
      itemEl.classList.add('active');
      itemEl.classList.remove('unread');
    }
    email.read = true;

    const emailViewEl = document.getElementById('emailViewContent');
    const isEn = localStorage.getItem('app_lang') === 'en';

    emailViewEl.innerHTML = `
        <div class="mail-header">
            <h1 class="mail-subject">${email.subject}</h1>
            <div class="mail-meta">
                <div class="avatar">${email.sender[0]}</div>
                <div class="meta-info">
                    <div>${email.sender}</div>
                    <div>${email.date}</div>
                </div>
            </div>
        </div>
        <div class="mail-body">
            ${email.content}
        </div>
    `;

    if(window.innerWidth <= 768) {
      document.getElementById('mainView').classList.add('active');
      const backBtn = document.createElement('button');
      backBtn.className = 'btn btn-ghost';
      backBtn.innerHTML = isEn ? 'â† Back' : 'â† è¿”å›åˆ—è¡¨';
      backBtn.style.marginBottom = '1rem';
      backBtn.onclick = () => document.getElementById('mainView').classList.remove('active');
      emailViewEl.prepend(backBtn);
    }
  }

  window.logout = function() {
    sessionStorage.clear();
    window.location.href = 'email-login.html';
  }

  document.getElementById('emailSearchInput').addEventListener('input', (e) => {
    renderList(getEmailsToDisplay(e.target.value));
  });

  (async function(){
    const currentLang = localStorage.getItem('app_lang') || 'cn';
    await window.reloadConfig(currentLang);
  })();

</script>
</body>
</html>